# 企業員工管理系統 - 系統邏輯文檔 v2.0

## 📋 系統概述

本系統是一個完整的企業員工管理平台，包含員工認證、GPS打卡、營收管理、庫存管理、排班系統、升遷投票等核心功能模組。

## 🏗️ 系統架構

### 核心技術棧
- **後端**: Node.js + Express.js
- **資料庫**: SQLite (Sequelize ORM)
- **前端**: HTML5 + Bootstrap 5 + JavaScript
- **通訊**: WebSocket + RESTful API
- **通知**: Telegram Bot API

### 資料庫架構 (20個核心表)
1. **employees** - 員工基本資料
2. **stores** - 分店資訊
3. **attendance_records** - GPS打卡記錄  
4. **revenue_records** - 營收記錄
5. **inventory_items** - 庫存商品
6. **inventory_orders** - 叫貨單
7. **inventory_logs** - 庫存異動記錄
8. **inventory_alerts** - 庫存警報
9. **schedules** - 員工排班記錄
10. **schedule_configs** - 排班配置
11. **schedule_sessions** - 排班時段
12. **work_assignments** - 值班分配
13. **promotion_campaigns** - 升遷投票活動
14. **promotion_candidates** - 升遷候選人  
15. **promotion_votes** - 投票記錄
16. **attendance_statistics** - 遲到統計 (新增)
17. **vote_modification_history** - 投票修改歷史 (新增)
18. **maintenance_requests** - 維修申請
19. **system_logs** - 系統日誌  
20. **notification_queue** - 通知佇列

## 👤 員工認證系統

### 註冊資料 (11個必填欄位)
1. **name** - 員工姓名 (登入帳號)
2. **idNumber** - 身分證字號 (登入密碼)  
3. **birthDate** - 出生日期
4. **gender** - 性別 (男/女/其他)
5. **hasDriverLicense** - 是否持有駕照
6. **phone** - 聯絡電話
7. **address** - 住址
8. **emergencyContactName** - 緊急聯絡人姓名
9. **emergencyContactRelation** - 緊急聯絡人關係
10. **emergencyContactPhone** - 緊急聯絡人電話
11. **hireDate** - 到職日期

### 職位階級系統
- **實習生** (預設) - 新進員工初始職位
- **員工** - 轉正後基本職位  
- **副店長** - 中階管理職位
- **店長** - 高階管理職位
- **區域經理** - 最高階職位

### 員工狀態管理
- **在職** - 正常工作狀態
- **離職** - 已離開公司
- **留職停薪** - 暫時停止工作
- **審核中** - 新註冊待審核狀態

## 📍 GPS打卡系統

### 打卡規則
- **工作時間**: 09:00-18:00 (可調整)
- **打卡類型**: 上班打卡 / 下班打卡
- **地理限制**: 距離分店50公尺內有效
- **設備檢測**: 防止多裝置同時打卡

### 打卡狀態判定
- **正常** - 準時打卡
- **遲到** - 超過上班時間打卡  
- **早退** - 提前下班打卡
- **異常** - 地點或設備異常

### 遲到統計系統 (新增)
- **月度統計**: 每月統計遲到次數和分鐘數
- **自動重置**: 每月1號00:00自動重置
- **懲罰觸發**: 遲到次數>3次 OR 總分鐘數>10分鐘
- **連續監控**: 支援同月內多次懲罰投票

## 💰 營收管理系統

### 營收記錄
- **每日營收**: 各分店日營收記錄
- **獎金計算**: 基於營收自動計算獎金
- **績效分析**: 月度、季度績效報告
- **目標管理**: 營收目標設定與追蹤

## 📦 庫存管理系統

### 庫存功能
- **商品管理**: 庫存商品基本資料
- **進貨管理**: 叫貨單創建與處理
- **庫存預警**: 低庫存自動警報
- **異動追蹤**: 所有庫存異動完整記錄

## 📅 智慧排班系統

### 6重規則引擎
1. **基本時段檢查** - 驗證排班時段有效性
2. **員工可用性檢查** - 確認員工當日可工作
3. **最低人力要求** - 保證每時段基本人力
4. **連續工作限制** - 避免過度勞累
5. **公平性分配** - 均衡工作時數分配  
6. **特殊需求處理** - 處理請假、調班等需求

### 排班通知系統
- **排班完成通知** - 員工排班提交確認
- **衝突警告** - 排班衝突即時提醒
- **截止提醒** - 排班截止日期提醒
- **統計報告** - 月度排班統計報告

## 🗳️ 升遷投票系統 (完整版)

### 基礎投票機制
- **匿名投票**: 使用SHA-256加密保護投票者身份
- **候選人匿名化**: 使用CANDIDATE_X_001格式匿名ID
- **投票類型**: 單選、多選、排序投票
- **權限控制**: 基於職位和年資的投票資格

### 投票修改機制 (新增)
- **修改次數**: 每人每次投票可修改3次
- **修改記錄**: 完整記錄每次修改歷史
- **最終決定**: 以最後一次投票為準
- **修改限制**: 投票結束前24小時內不可修改

### 自動投票系統

#### A. 新人轉正自動投票
**觸發條件**: 員工到職滿20天
**投票時長**: 5天 (00:00開始到00:00結束)  
**參與者**: 全體在職員工
**通過標準**: 50%同意比例
**失敗處理**: 30天緩衝期後可由員工自己申請
**系統行為**: 
- 每日00:00自動檢查符合條件的員工
- 自動創建轉正投票活動
- 發送Telegram通知到管理員和員工群組
- 系統僅自動發起第一次，後續需手動申請

#### B. 降職懲罰自動投票  
**觸發條件**: 
- 月遲到總分鐘數 > 10分鐘 OR
- 月遲到次數 > 3次
**投票時長**: 3天
**參與者**: 全體在職員工
**通過標準**: 30%同意比例即成立
**執行特性**:
- 無緩衝期，可連續觸發
- 智慧階級降級分析
- 如第一次懲罰進行中又觸發第二次，系統自動分析第一次結果預測來決定第二次目標職位
- 每月1號00:00重置遲到統計

### 多重投票管理系統 (新增)
**並發規則**:
- 系統自動投票不受其他投票影響
- 可同時進行多個系統投票活動  
- 員工手動申請投票需檢查是否有衝突
- 管理員可手動開啟任何類型的投票

**投票優先級**:
1. **系統降職懲罰投票** (最高優先級)
2. **系統新人轉正投票** (高優先級)  
3. **管理員手動投票** (中優先級)
4. **員工申請投票** (低優先級)

### 投票通知模板 (29種)

#### 基礎投票通知 (8種)
1. 投票活動開始通知
2. 投票活動結束通知
3. 投票結果公告
4. 投票資格確認  
5. 投票提醒 (24小時前)
6. 投票提醒 (1小時前)
7. 投票修改確認
8. 投票衝突警告

#### 新人轉正通知 (7種)  
9. 新人到職20天提醒 (管理員)
10. 新人轉正投票開始 (全員)
11. 新人轉正投票結果 (成功)
12. 新人轉正投票結果 (失敗)  
13. 轉正緩衝期開始通知
14. 轉正緩衝期結束提醒
15. 員工自主轉正申請通知

#### 降職懲罰通知 (8種)
16. 遲到統計警告 (接近觸發)
17. 降職懲罰投票觸發 (管理員)
18. 降職懲罰投票開始 (全員)  
19. 降職懲罰投票結果 (成立)
20. 降職懲罰投票結果 (不成立)
21. 連續懲罰投票警告
22. 月度遲到統計重置通知
23. 職位降級執行通知

#### 管理員專用通知 (6種)
24. 多重投票狀態報告
25. 投票系統異常警報  
26. 定時任務執行報告
27. 投票數據統計報告
28. 系統維護通知
29. 緊急狀況通知

## 🔧 維修保養系統

### 維修申請流程
- **申請創建**: 員工發現設備問題提交申請
- **優先級評估**: 系統自動評估維修優先級
- **派工分配**: 自動或手動分配維修人員
- **進度追蹤**: 維修進度即時更新
- **完工確認**: 申請人確認維修完成

## 📱 Telegram通知系統

### 通知群組
- **管理員群組**: 管理相關通知
- **員工群組**: 一般員工通知  
- **系統監控群組**: 系統狀態通知

### 自動通知觸發
- **新員工註冊**: 管理員群組通知
- **投票活動**: 相關群組通知
- **系統異常**: 監控群組通知
- **維修申請**: 管理員群組通知

## ⏰ 定時任務系統

### 每日任務 (00:00執行)
1. **檢查新人轉正條件** - 掃描到職滿20天的實習生
2. **檢查投票活動到期** - 處理到期投票的結果統計
3. **檢查遲到懲罰條件** - 分析月度遲到統計觸發懲罰投票
4. **發送投票提醒通知** - 提醒未投票的員工參與投票
5. **系統健康檢查** - 檢查各模組運行狀態

### 每月任務 (1號00:00執行)  
1. **重置遲到統計** - 清零所有員工月度遲到數據
2. **生成月度報告** - 營收、排班、投票等統計報告
3. **清理過期數據** - 清理超過保存期限的歷史數據
4. **備份系統數據** - 創建月度數據備份

## 🔐 權限管理系統

### 角色定義
- **超級管理員**: 全系統權限
- **分店管理員**: 分店範圍權限  
- **一般員工**: 基礎功能權限
- **實習生**: 受限功能權限

### 功能權限矩陣
```
功能模組          超管  分管  員工  實習
員工註冊          ✓     ✓     ✗    ✗
GPS打卡          ✓     ✓     ✓    ✓  
營收管理          ✓     ✓     ✗    ✗
庫存管理          ✓     ✓     ✓    ✗
排班系統          ✓     ✓     ✓    ✓
升遷投票          ✓     ✓     ✓    ✗
維修申請          ✓     ✓     ✓    ✓
手動開啟投票      ✓     ✓     ✗    ✗
```

## 📊 系統監控

### 效能監控
- **API響應時間**: 監控各API端點效能
- **資料庫查詢**: 監控慢查詢和死鎖
- **記憶體使用**: 監控系統記憶體消耗
- **併發處理**: 監控同時在線用戶數

### 業務監控  
- **投票參與率**: 監控員工投票活躍度
- **打卡異常率**: 監控GPS打卡異常情況
- **系統錯誤率**: 監控各模組錯誤頻率
- **通知送達率**: 監控Telegram通知成功率

## 🚨 異常處理機制

### 自動投票異常
- **重複觸發防護**: 防止同一條件重複創建投票
- **投票衝突解決**: 智慧處理多重投票時間重疊
- **資料不一致修復**: 自動檢測並修復投票數據異常
- **通知失敗重試**: Telegram通知失敗自動重發機制

### 系統故障恢復
- **資料庫連線中斷**: 自動重連和事務回滾
- **定時任務失效**: 任務執行狀態檢查和補償機制  
- **併發衝突處理**: 樂觀鎖和悲觀鎖結合使用
- **緊急停機機制**: 系統異常時的安全停機流程

## 📈 未來擴展規劃

### 短期計劃 (1-3個月)
- 手機APP開發
- 人臉識別打卡  
- 更多投票類型支援
- 高級統計報表

### 中期計劃 (3-6個月)
- 多分店管理
- 薪資計算系統
- 績效考核系統
- 客戶關係管理

### 長期計劃 (6-12個月)  
- AI智慧排班
- 預測性維修
- 商業智能分析
- 雲端部署遷移

---

## 📋 系統更新日誌

### v2.0 (2025-08-10) - 升遷投票系統完整版
- ✅ 新增投票修改機制 (3次修改機會)
- ✅ 新增新人轉正自動投票系統  
- ✅ 新增降職懲罰自動投票系統
- ✅ 新增多重投票管理機制
- ✅ 新增遲到統計系統
- ✅ 擴展29種Telegram通知模板
- ✅ 新增定時任務自動觸發機制

### v1.0 (2025-08-09) - 基礎系統完整版  
- ✅ 完成員工認證系統
- ✅ 完成GPS打卡系統
- ✅ 完成營收管理系統  
- ✅ 完成庫存管理系統
- ✅ 完成智慧排班系統(6重規則引擎)
- ✅ 完成基礎升遷投票系統(匿名投票)
- ✅ 完成Telegram通知基礎功能

---

**文檔版本**: v2.0
**最後更新**: 2025-08-10  
**維護者**: Claude AI Assistant
**系統狀態**: 生產就緒