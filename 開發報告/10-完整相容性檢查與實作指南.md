# ğŸ”§ ä¼æ¥­å“¡å·¥ç®¡ç†ç³»çµ± - å®Œæ•´ç›¸å®¹æ€§æª¢æŸ¥èˆ‡å¯¦ä½œæŒ‡å—

## ğŸ“‹ æ–‡æª”æ¦‚è¿°

æœ¬æŒ‡å—æ•´åˆæ‰€æœ‰é–‹ç™¼å ±å‘Šçš„å»ºè­°äº‹é …ï¼Œç¢ºä¿ç›¸å®¹æ€§ä¸¦æä¾›å…·é«”å¯¦ä½œç´°ç¯€ã€‚

**å»ºç«‹æ—¥æœŸ**: 2025-08-06  
**ç›®çš„**: è§£æ±ºå ±å‘Šé–“çš„è¡çªï¼Œæä¾›çµ±ä¸€å¯¦ä½œæ¨™æº–  
**é©ç”¨å°è±¡**: æ–°åŠ å…¥çš„é–‹ç™¼äººå“¡

---

## ğŸ” ç›¸å®¹æ€§å•é¡Œè­˜åˆ¥èˆ‡ä¿®æ­£

### 1. Telegram é…ç½®çµ±ä¸€æ¨™æº–

#### âŒ å•é¡Œï¼šé…ç½®ä¸ä¸€è‡´
- å ±å‘Š 03 æåˆ° botToken ä½†æœªæä¾›å¯¦éš›å€¼
- å ±å‘Š 08 æœ‰å®Œæ•´ botToken ä½†ç¾¤çµ„ ID ç›¸åŒ
- å ±å‘Š 09 å»ºè­°ç®¡ç†ä»‹é¢ä½†ç¼ºå°‘å¯¦ä½œ

#### âœ… çµ±ä¸€è§£æ±ºæ–¹æ¡ˆ
```javascript
// config/telegram.config.js
const TELEGRAM_CONFIG = {
    botToken: '7659930552:AAF_jF1rAXFnjFO176-9X5fKfBwbrko8BNc',
    groups: {
        // åˆå§‹ç›¸åŒï¼Œä¹‹å¾Œå¯å¾ç®¡ç†ä»‹é¢ä¿®æ”¹
        boss: '-1002658082392',
        employee: '-1002658082392'  // å°‡æœƒåœ¨ç³»çµ±ä¸Šç·šå¾Œä¿®æ”¹
    },
    enabled: true,
    messageTemplates: {
        clockIn: 'ğŸ”” æ‰“å¡é€šçŸ¥\nå“¡å·¥ï¼š{name}\næ™‚é–“ï¼š{time}\nç‹€æ…‹ï¼š{status}',
        revenue: 'ğŸ’° ç‡Ÿæ”¶é€šçŸ¥\næ—¥æœŸï¼š{date}\næ·¨æ”¶å…¥ï¼š{amount}',
        lowStock: 'ğŸ“¦ åº«å­˜è­¦å‘Š\nå“é …ï¼š{item}\nç•¶å‰ï¼š{current}\næœ€ä½ï¼š{minimum}'
    }
};

module.exports = TELEGRAM_CONFIG;
```

### 2. è·¨æ—¥ç­æ¬¡é‚è¼¯çµ±ä¸€å¯¦ä½œ

#### âŒ å•é¡Œï¼šè·¨æ—¥è™•ç†é‚è¼¯ä¸ä¸€è‡´
- å ±å‘Š 02 åªæåˆ°å›ºå®šç­æ¬¡ä½†ç„¡å¯¦ä½œ
- å ±å‘Š 08 æœ‰ getShiftDate ä½†ç¼ºå°‘å®Œæ•´é‚è¼¯
- å ±å‘Š 09 æä¾›äº†è©³ç´°å¯¦ä½œä½†æœªæ•´åˆåˆ°ä¸»ç³»çµ±

#### âœ… å®Œæ•´å¯¦ä½œæ–¹æ¡ˆ
```javascript
// utils/shift-handler.js
class ShiftHandler {
    constructor() {
        // å›ºå®šç­æ¬¡æ™‚é–“ 15:00-02:00
        this.shiftStart = { hour: 15, minute: 0 };
        this.shiftEnd = { hour: 2, minute: 0 };
        this.graceMinutes = 10;
    }
    
    /**
     * å–å¾—ç­æ¬¡æ—¥æœŸï¼ˆè™•ç†è·¨æ—¥ï¼‰
     * @param {Date|string} clockTime - æ‰“å¡æ™‚é–“
     * @returns {string} YYYY-MM-DD æ ¼å¼çš„ç­æ¬¡æ—¥æœŸ
     */
    getShiftDate(clockTime) {
        const time = new Date(clockTime);
        const hour = time.getHours();
        
        // å‡Œæ™¨ 00:00-02:59 å±¬æ–¼å‰ä¸€å¤©ç­æ¬¡
        if (hour >= 0 && hour < 3) {
            const shiftDate = new Date(time);
            shiftDate.setDate(shiftDate.getDate() - 1);
            return shiftDate.toISOString().split('T')[0];
        }
        
        // å…¶ä»–æ™‚é–“å±¬æ–¼ç•¶å¤©ç­æ¬¡
        return time.toISOString().split('T')[0];
    }
    
    /**
     * æª¢æŸ¥æ˜¯å¦é²åˆ°
     * @param {Date|string} clockInTime - ä¸Šç­æ‰“å¡æ™‚é–“
     * @returns {Object} { isLate: boolean, lateMinutes: number }
     */
    checkIfLate(clockInTime) {
        const time = new Date(clockInTime);
        const hour = time.getHours();
        const minute = time.getMinutes();
        
        // è¨ˆç®—ç›¸å°æ–¼ 15:00 çš„åˆ†é˜æ•¸
        const clockMinutes = hour * 60 + minute;
        const shiftStartMinutes = this.shiftStart.hour * 60 + this.shiftStart.minute;
        const graceEndMinutes = shiftStartMinutes + this.graceMinutes;
        
        // 15:00-15:10 ä¸ç®—é²åˆ°
        if (clockMinutes >= shiftStartMinutes && clockMinutes <= graceEndMinutes) {
            return { isLate: false, lateMinutes: 0 };
        }
        
        // è¶…é 15:10 ç®—é²åˆ°
        if (clockMinutes > graceEndMinutes) {
            const lateMinutes = clockMinutes - graceEndMinutes;
            return { isLate: true, lateMinutes };
        }
        
        // æ—©æ–¼ 15:00 ä¸ç®—é²åˆ°
        return { isLate: false, lateMinutes: 0 };
    }
    
    /**
     * è¨ˆç®—å·¥ä½œæ™‚æ•¸ï¼ˆè™•ç†è·¨æ—¥ï¼‰
     * @param {Date|string} clockIn - ä¸Šç­æ™‚é–“
     * @param {Date|string} clockOut - ä¸‹ç­æ™‚é–“
     * @returns {number} å·¥ä½œå°æ™‚æ•¸
     */
    calculateWorkHours(clockIn, clockOut) {
        const inTime = new Date(clockIn);
        const outTime = new Date(clockOut);
        
        // å¦‚æœä¸‹ç­æ™‚é–“æ—©æ–¼ä¸Šç­æ™‚é–“ï¼Œè¡¨ç¤ºè·¨æ—¥
        if (outTime < inTime) {
            outTime.setDate(outTime.getDate() + 1);
        }
        
        const diffMs = outTime - inTime;
        const hours = diffMs / (1000 * 60 * 60);
        
        return Math.round(hours * 100) / 100; // ä¿ç•™å…©ä½å°æ•¸
    }
    
    /**
     * é©—è­‰æ˜¯å¦åœ¨æ­£å¸¸æ‰“å¡æ™‚é–“ç¯„åœå…§
     * @param {Date|string} time - æ‰“å¡æ™‚é–“
     * @param {string} type - 'in' æˆ– 'out'
     * @returns {boolean}
     */
    isValidClockTime(time, type) {
        const clockTime = new Date(time);
        const hour = clockTime.getHours();
        
        if (type === 'in') {
            // ä¸Šç­æ‰“å¡å…è¨±æ™‚é–“ï¼š14:00-16:00
            return hour >= 14 && hour <= 16;
        } else {
            // ä¸‹ç­æ‰“å¡å…è¨±æ™‚é–“ï¼š01:00-03:00 æˆ– 02:00 ä¹‹å¾Œ
            return (hour >= 1 && hour <= 3) || hour >= 2;
        }
    }
}

module.exports = new ShiftHandler();
```

### 3. æª”æ¡ˆä¸Šå‚³å®Œæ•´å¯¦ä½œ

#### âŒ å•é¡Œï¼šæª”æ¡ˆä¸Šå‚³å¯¦ä½œåˆ†æ•£
- å ±å‘Š 04 API åªå®šç¾©äº†ä»‹é¢ä½†ç„¡å¯¦ä½œ
- å ±å‘Š 08 æåˆ° Cloud Storage ä½†ç„¡å…·é«”ä»£ç¢¼
- å ±å‘Š 09 æœ‰å‰ç«¯å¯¦ä½œä½†ç¼ºå°‘å¾Œç«¯æ•´åˆ

#### âœ… Cloud Storage æ•´åˆæ–¹æ¡ˆ
```javascript
// services/storage.service.js
const { Storage } = require('@google-cloud/storage');
const sharp = require('sharp');
const crypto = require('crypto');

class StorageService {
    constructor() {
        this.storage = new Storage();
        this.bucketName = process.env.STORAGE_BUCKET || 'employee-mgmt-2025';
        this.bucket = this.storage.bucket(this.bucketName);
        
        this.config = {
            maxSize: 5 * 1024 * 1024, // 5MB
            allowedTypes: ['image/jpeg', 'image/png', 'image/webp'],
            imageQuality: 85,
            thumbnailSize: { width: 200, height: 200 }
        };
    }
    
    /**
     * ä¸Šå‚³æª”æ¡ˆåˆ° Cloud Storage
     * @param {Buffer|Stream} file - æª”æ¡ˆå…§å®¹
     * @param {Object} metadata - æª”æ¡ˆè³‡è¨Š
     * @returns {Promise<Object>} ä¸Šå‚³çµæœ
     */
    async uploadFile(file, metadata) {
        try {
            // 1. é©—è­‰æª”æ¡ˆ
            this.validateFile(metadata);
            
            // 2. ç”Ÿæˆå”¯ä¸€æª”å
            const fileName = this.generateFileName(metadata);
            const filePath = `${metadata.category}/${fileName}`;
            
            // 3. è™•ç†åœ–ç‰‡ï¼ˆå£“ç¸®ã€è½‰æ›æ ¼å¼ï¼‰
            const processedImage = await this.processImage(file, metadata.mimetype);
            
            // 4. ä¸Šå‚³åˆ° Cloud Storage
            const fileRef = this.bucket.file(filePath);
            const stream = fileRef.createWriteStream({
                metadata: {
                    contentType: 'image/jpeg',
                    metadata: {
                        originalName: metadata.originalName,
                        uploadedBy: metadata.userId,
                        uploadedAt: new Date().toISOString()
                    }
                }
            });
            
            return new Promise((resolve, reject) => {
                stream.on('error', reject);
                stream.on('finish', async () => {
                    // 5. ç”Ÿæˆç°½å URLï¼ˆæœ‰æ•ˆæœŸ 7 å¤©ï¼‰
                    const [url] = await fileRef.getSignedUrl({
                        action: 'read',
                        expires: Date.now() + 7 * 24 * 60 * 60 * 1000
                    });
                    
                    // 6. ç”Ÿæˆç¸®åœ–
                    const thumbnailUrl = await this.generateThumbnail(
                        processedImage,
                        filePath
                    );
                    
                    resolve({
                        url,
                        thumbnailUrl,
                        path: filePath,
                        size: processedImage.length,
                        bucket: this.bucketName
                    });
                });
                
                stream.end(processedImage);
            });
            
        } catch (error) {
            console.error('ä¸Šå‚³å¤±æ•—:', error);
            throw new Error(`æª”æ¡ˆä¸Šå‚³å¤±æ•—: ${error.message}`);
        }
    }
    
    /**
     * é©—è­‰æª”æ¡ˆ
     */
    validateFile(metadata) {
        if (metadata.size > this.config.maxSize) {
            throw new Error(`æª”æ¡ˆå¤§å°è¶…éé™åˆ¶ ${this.config.maxSize / 1024 / 1024}MB`);
        }
        
        if (!this.config.allowedTypes.includes(metadata.mimetype)) {
            throw new Error('ä¸æ”¯æ´çš„æª”æ¡ˆæ ¼å¼');
        }
    }
    
    /**
     * è™•ç†åœ–ç‰‡
     */
    async processImage(buffer, mimetype) {
        try {
            // ä½¿ç”¨ sharp è™•ç†åœ–ç‰‡
            let image = sharp(buffer);
            
            // å–å¾—åœ–ç‰‡è³‡è¨Š
            const metadata = await image.metadata();
            
            // èª¿æ•´å¤§å°ï¼ˆå¦‚æœå¤ªå¤§ï¼‰
            if (metadata.width > 1920 || metadata.height > 1080) {
                image = image.resize(1920, 1080, {
                    fit: 'inside',
                    withoutEnlargement: true
                });
            }
            
            // è½‰æ›ç‚º JPEG ä¸¦å£“ç¸®
            return await image
                .jpeg({ quality: this.config.imageQuality })
                .toBuffer();
                
        } catch (error) {
            console.error('åœ–ç‰‡è™•ç†å¤±æ•—:', error);
            throw new Error('åœ–ç‰‡è™•ç†å¤±æ•—');
        }
    }
    
    /**
     * ç”Ÿæˆå”¯ä¸€æª”å
     */
    generateFileName(metadata) {
        const timestamp = Date.now();
        const random = crypto.randomBytes(8).toString('hex');
        const ext = 'jpg'; // çµ±ä¸€è½‰æ›ç‚º JPEG
        return `${timestamp}_${random}.${ext}`;
    }
    
    /**
     * ç”Ÿæˆç¸®åœ–
     */
    async generateThumbnail(imageBuffer, originalPath) {
        try {
            const thumbnail = await sharp(imageBuffer)
                .resize(this.config.thumbnailSize)
                .toBuffer();
            
            const thumbnailPath = originalPath.replace('.jpg', '_thumb.jpg');
            const thumbnailRef = this.bucket.file(thumbnailPath);
            
            await thumbnailRef.save(thumbnail, {
                metadata: {
                    contentType: 'image/jpeg'
                }
            });
            
            const [url] = await thumbnailRef.getSignedUrl({
                action: 'read',
                expires: Date.now() + 7 * 24 * 60 * 60 * 1000
            });
            
            return url;
            
        } catch (error) {
            console.error('ç¸®åœ–ç”Ÿæˆå¤±æ•—:', error);
            return null;
        }
    }
}

module.exports = new StorageService();
```

### 4. çµ±ä¸€éŒ¯èª¤è™•ç†æ©Ÿåˆ¶

#### âŒ å•é¡Œï¼šéŒ¯èª¤ä»£ç¢¼ä¸ä¸€è‡´
- å ±å‘Š 04 å®šç¾©äº† HTTP ç‹€æ…‹ç¢¼
- å ±å‘Š 08 ä½¿ç”¨ E001-E005 éŒ¯èª¤ç¢¼
- å ±å‘Š 09 åˆå®šç¾©äº†ä¸åŒçš„éŒ¯èª¤ç¢¼ç³»çµ±

#### âœ… å…¨åŸŸéŒ¯èª¤è™•ç†å¯¦ä½œ
```javascript
// middleware/error-handler.js
const { Logging } = require('@google-cloud/logging');

class ErrorHandler {
    constructor() {
        this.logging = new Logging();
        this.log = this.logging.log('employee-app-errors');
        
        this.errorCodes = {
            // èªè­‰éŒ¯èª¤
            E001: { status: 401, message: 'èªè­‰å¤±æ•—ï¼Œè«‹é‡æ–°ç™»å…¥' },
            E002: { status: 403, message: 'æ¬Šé™ä¸è¶³' },
            
            // GPS éŒ¯èª¤
            E101: { status: 400, message: 'ç„¡æ³•å–å¾— GPS å®šä½' },
            E102: { status: 400, message: 'è·é›¢è¶…é 100 å…¬å°ºé™åˆ¶' },
            E103: { status: 400, message: 'GPS ç²¾åº¦ä¸è¶³ï¼Œè«‹ç§»è‡³é–‹é—Šåœ°å¸¶' },
            
            // æª”æ¡ˆéŒ¯èª¤
            E201: { status: 400, message: 'æª”æ¡ˆå¤§å°è¶…éé™åˆ¶' },
            E202: { status: 400, message: 'ä¸æ”¯æ´çš„æª”æ¡ˆæ ¼å¼' },
            E203: { status: 500, message: 'æª”æ¡ˆä¸Šå‚³å¤±æ•—' },
            
            // è³‡æ–™åº«éŒ¯èª¤
            E301: { status: 404, message: 'æ‰¾ä¸åˆ°è³‡æ–™' },
            E302: { status: 409, message: 'è³‡æ–™å·²å­˜åœ¨' },
            E303: { status: 500, message: 'è³‡æ–™åº«æ“ä½œå¤±æ•—' },
            
            // æ¥­å‹™é‚è¼¯éŒ¯èª¤
            E401: { status: 400, message: 'å·²ç¶“æ‰“éå¡' },
            E402: { status: 400, message: 'ä¸åœ¨æ‰“å¡æ™‚é–“ç¯„åœå…§' },
            E403: { status: 400, message: 'ç‡Ÿæ”¶è³‡æ–™ä¸å®Œæ•´' },
            E404: { status: 400, message: 'åº«å­˜ä¸è¶³' }
        };
    }
    
    /**
     * Express éŒ¯èª¤è™•ç†ä¸­ä»‹è»Ÿé«”
     */
    middleware() {
        return async (err, req, res, next) => {
            // è¨˜éŒ„éŒ¯èª¤
            await this.logError(err, req);
            
            // è™•ç†å·²çŸ¥éŒ¯èª¤
            if (err.code && this.errorCodes[err.code]) {
                const errorInfo = this.errorCodes[err.code];
                return res.status(errorInfo.status).json({
                    success: false,
                    code: err.code,
                    message: errorInfo.message,
                    timestamp: new Date().toISOString()
                });
            }
            
            // è™•ç† Firestore éŒ¯èª¤
            if (err.code && err.code.startsWith('firestore')) {
                return res.status(500).json({
                    success: false,
                    code: 'E303',
                    message: 'è³‡æ–™åº«æ“ä½œå¤±æ•—',
                    timestamp: new Date().toISOString()
                });
            }
            
            // è™•ç†é©—è­‰éŒ¯èª¤
            if (err.name === 'ValidationError') {
                return res.status(400).json({
                    success: false,
                    code: 'E400',
                    message: 'è¼¸å…¥è³‡æ–™é©—è­‰å¤±æ•—',
                    details: err.details,
                    timestamp: new Date().toISOString()
                });
            }
            
            // è™•ç†æœªçŸ¥éŒ¯èª¤
            console.error('æœªè™•ç†çš„éŒ¯èª¤:', err);
            res.status(500).json({
                success: false,
                code: 'E500',
                message: 'ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦',
                timestamp: new Date().toISOString()
            });
        };
    }
    
    /**
     * è¨˜éŒ„éŒ¯èª¤åˆ° Cloud Logging
     */
    async logError(err, req) {
        const metadata = {
            severity: err.severity || 'ERROR',
            labels: {
                environment: process.env.NODE_ENV,
                userId: req.user?.id || 'anonymous',
                path: req.path,
                method: req.method
            }
        };
        
        const entry = this.log.entry(metadata, {
            message: err.message,
            code: err.code,
            stack: err.stack,
            body: req.body,
            query: req.query,
            ip: req.ip,
            userAgent: req.get('user-agent'),
            timestamp: new Date().toISOString()
        });
        
        try {
            await this.log.write(entry);
        } catch (logError) {
            console.error('è¨˜éŒ„éŒ¯èª¤å¤±æ•—:', logError);
        }
    }
    
    /**
     * å»ºç«‹è‡ªè¨‚éŒ¯èª¤
     */
    static createError(code, additionalInfo) {
        const error = new Error();
        error.code = code;
        if (additionalInfo) {
            error.additionalInfo = additionalInfo;
        }
        return error;
    }
}

module.exports = ErrorHandler;
```

### 5. Telegram ç®¡ç†ä»‹é¢å¯¦ä½œ

#### âŒ å•é¡Œï¼šç®¡ç†ä»‹é¢éœ€æ±‚ä¸æ˜ç¢º
- å ±å‘Š 02 æåˆ°å¯ä¿®æ”¹ç¾¤çµ„ ID ä½†ç„¡ä»‹é¢è¨­è¨ˆ
- å ±å‘Š 05 æœ‰ UI å…ƒä»¶ä½†ç¼ºå°‘å°æ‡‰åŠŸèƒ½
- å ±å‘Š 09 æä¾›äº† HTML ä½†ç„¡å®Œæ•´äº’å‹•é‚è¼¯

#### âœ… ç®¡ç†é é¢å®Œæ•´å¯¦ä½œ
```javascript
// pages/admin/telegram-settings.js
class TelegramSettings {
    constructor() {
        this.form = document.getElementById('telegramSettingsForm');
        this.init();
    }
    
    async init() {
        // è¼‰å…¥ç•¶å‰è¨­å®š
        await this.loadCurrentSettings();
        
        // ç¶å®šäº‹ä»¶
        this.form.addEventListener('submit', (e) => this.handleSubmit(e));
        
        // æ¸¬è©¦æŒ‰éˆ•
        document.getElementById('testBossGroup').addEventListener('click', 
            () => this.testNotification('boss'));
        document.getElementById('testEmployeeGroup').addEventListener('click', 
            () => this.testNotification('employee'));
    }
    
    async loadCurrentSettings() {
        try {
            const doc = await db.collection('settings').doc('telegram').get();
            if (doc.exists) {
                const settings = doc.data().settings;
                document.getElementById('botToken').value = settings.botToken;
                document.getElementById('bossGroupId').value = settings.bossGroupId;
                document.getElementById('employeeGroupId').value = settings.employeeGroupId;
                document.getElementById('notificationEnabled').checked = settings.notificationEnabled;
            }
        } catch (error) {
            ErrorHandler.handle(error, 'loadTelegramSettings');
        }
    }
    
    async handleSubmit(e) {
        e.preventDefault();
        
        const settings = {
            botToken: document.getElementById('botToken').value,
            bossGroupId: document.getElementById('bossGroupId').value,
            employeeGroupId: document.getElementById('employeeGroupId').value,
            notificationEnabled: document.getElementById('notificationEnabled').checked
        };
        
        try {
            // é©—è­‰ç¾¤çµ„ ID æ ¼å¼
            if (!this.validateGroupId(settings.bossGroupId) || 
                !this.validateGroupId(settings.employeeGroupId)) {
                throw new Error('ç¾¤çµ„ ID æ ¼å¼éŒ¯èª¤');
            }
            
            // æ›´æ–°è¨­å®š
            await db.collection('settings').doc('telegram').set({
                settings,
                updatedBy: currentUser.id,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
            
            this.showSuccess('è¨­å®šå·²å„²å­˜');
            
        } catch (error) {
            this.showError(error.message);
        }
    }
    
    validateGroupId(groupId) {
        // Telegram ç¾¤çµ„ ID æ ¼å¼ï¼š-100 é–‹é ­çš„æ•¸å­—
        return /^-100\d{10,}$/.test(groupId);
    }
    
    async testNotification(type) {
        try {
            const response = await fetch('/api/admin/test-telegram', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify({ type })
            });
            
            const result = await response.json();
            if (result.success) {
                this.showSuccess(`æ¸¬è©¦è¨Šæ¯å·²ç™¼é€åˆ°${type === 'boss' ? 'è€é—†' : 'å“¡å·¥'}ç¾¤çµ„`);
            } else {
                this.showError(result.message);
            }
            
        } catch (error) {
            this.showError('æ¸¬è©¦å¤±æ•—: ' + error.message);
        }
    }
    
    showSuccess(message) {
        const alert = document.createElement('div');
        alert.className = 'alert alert-success';
        alert.textContent = message;
        document.body.appendChild(alert);
        setTimeout(() => alert.remove(), 3000);
    }
    
    showError(message) {
        const alert = document.createElement('div');
        alert.className = 'alert alert-error';
        alert.textContent = message;
        document.body.appendChild(alert);
        setTimeout(() => alert.remove(), 5000);
    }
}

// é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
    new TelegramSettings();
});
```

#### HTML ä»‹é¢
```html
<!-- admin/telegram-settings.html -->
<div class="admin-page">
    <div class="page-header">
        <h1>Telegram é€šçŸ¥è¨­å®š</h1>
    </div>
    
    <div class="settings-card">
        <form id="telegramSettingsForm">
            <div class="form-section">
                <h3>Bot è¨­å®š</h3>
                <div class="form-group">
                    <label for="botToken">Bot Token</label>
                    <input 
                        type="text" 
                        id="botToken" 
                        readonly
                        class="form-control"
                        value="7659930552:AAF_jF1rAXFnjFO176-9X5fKfBwbrko8BNc"
                    />
                    <small class="form-text">Bot Token ç„¡æ³•ä¿®æ”¹</small>
                </div>
            </div>
            
            <div class="form-section">
                <h3>ç¾¤çµ„è¨­å®š</h3>
                <div class="form-group">
                    <label for="bossGroupId">è€é—†ç¾¤çµ„ ID</label>
                    <div class="input-group">
                        <input 
                            type="text" 
                            id="bossGroupId" 
                            class="form-control"
                            pattern="^-100\d{10,}$"
                            placeholder="-1002658082392"
                            required
                        />
                        <button 
                            type="button" 
                            id="testBossGroup"
                            class="btn btn-secondary"
                        >
                            æ¸¬è©¦ç™¼é€
                        </button>
                    </div>
                    <small class="form-text">æ ¼å¼ï¼š-100 é–‹é ­çš„æ•¸å­—</small>
                </div>
                
                <div class="form-group">
                    <label for="employeeGroupId">å“¡å·¥ç¾¤çµ„ ID</label>
                    <div class="input-group">
                        <input 
                            type="text" 
                            id="employeeGroupId" 
                            class="form-control"
                            pattern="^-100\d{10,}$"
                            placeholder="-1002658082393"
                            required
                        />
                        <button 
                            type="button" 
                            id="testEmployeeGroup"
                            class="btn btn-secondary"
                        >
                            æ¸¬è©¦ç™¼é€
                        </button>
                    </div>
                    <small class="form-text">æ ¼å¼ï¼š-100 é–‹é ­çš„æ•¸å­—</small>
                </div>
            </div>
            
            <div class="form-section">
                <h3>é€šçŸ¥è¨­å®š</h3>
                <div class="form-check">
                    <input 
                        type="checkbox" 
                        id="notificationEnabled" 
                        class="form-check-input"
                        checked
                    />
                    <label for="notificationEnabled" class="form-check-label">
                        å•Ÿç”¨ Telegram é€šçŸ¥
                    </label>
                </div>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                    <i class="icon-save"></i> å„²å­˜è¨­å®š
                </button>
            </div>
        </form>
    </div>
    
    <div class="help-section">
        <h3>å¦‚ä½•å–å¾—ç¾¤çµ„ IDï¼Ÿ</h3>
        <ol>
            <li>å°‡ Bot åŠ å…¥ç¾¤çµ„</li>
            <li>åœ¨ç¾¤çµ„ä¸­ç™¼é€ä»»æ„è¨Šæ¯</li>
            <li>è¨ªå• https://api.telegram.org/bot[TOKEN]/getUpdates</li>
            <li>æ‰¾åˆ° "chat":{"id": å¾Œé¢çš„æ•¸å­—</li>
        </ol>
    </div>
</div>
```

---

## ğŸ” å…¶ä»–ç›¸å®¹æ€§å•é¡Œ

### 6. API ç«¯é»æ•¸é‡ä¸ä¸€è‡´

#### âŒ å•é¡Œï¼š
- å ±å‘Š 01 æåˆ° 33 å€‹ API ç«¯é»
- å ±å‘Š 04 åªå®šç¾©äº† 28 å€‹ç«¯é»
- ç¼ºå°‘çš„ç«¯é»ï¼šè¨­å®šç®¡ç†ã€çµ±è¨ˆå ±è¡¨ç­‰

#### âœ… è§£æ±ºæ–¹æ¡ˆï¼š
è£œå……ç¼ºå°‘çš„ API ç«¯é»å®šç¾©ï¼Œç¢ºä¿èˆ‡ç³»çµ±åŠŸèƒ½å°æ‡‰

### 7. è³‡æ–™è¡¨æ•¸é‡ç²¾ç°¡å¾Œçš„å½±éŸ¿

#### âŒ å•é¡Œï¼š
- åŸå§‹ 11 å€‹è¡¨ç²¾ç°¡è‡³ 7 å€‹è¡¨
- ç§»é™¤äº† schedulesã€maintenanceRequestsã€promotionVotesã€auditLogs
- ä½†æŸäº›åŠŸèƒ½ä»å¼•ç”¨é€™äº›è¡¨

#### âœ… è§£æ±ºæ–¹æ¡ˆï¼š
- ç¢ºèªæ‰€æœ‰ç¨‹å¼ç¢¼éƒ½å·²æ›´æ–°ç‚ºä½¿ç”¨ 7 å€‹æ ¸å¿ƒè¡¨
- ç§»é™¤å°å·²åˆªé™¤è¡¨çš„æ‰€æœ‰å¼•ç”¨
- ä½¿ç”¨ Cloud Logging æ›¿ä»£ auditLogs

---

## ğŸ“š æ–°é–‹ç™¼è€…åŸ·è¡ŒæŒ‡ä»¤æ‰‹å†Š

### ğŸš€ å¿«é€Ÿé–‹å§‹æŒ‡ä»¤åºåˆ—

```bash
# 1. ç’°å¢ƒæº–å‚™éšæ®µ
git clone <repository-url>
cd employee-management
npm install

# 2. Google Cloud è¨­ç½®
gcloud auth login
gcloud projects create employee-mgmt-2025
gcloud config set project employee-mgmt-2025

# 3. å•Ÿç”¨å¿…è¦çš„ API
gcloud services enable cloudbuild.googleapis.com run.googleapis.com firestore.googleapis.com storage.googleapis.com firebase.googleapis.com

# 4. Firebase åˆå§‹åŒ–
firebase login
firebase init
# é¸æ“‡: Firestore, Storage, Hosting

# 5. ç’°å¢ƒè®Šæ•¸è¨­ç½®
cp .env.example .env
# ç·¨è¼¯ .env å¡«å…¥å¿…è¦è³‡è¨Š
```

### ğŸ“– é–‹ç™¼é †åºæŒ‡å—

#### Phase 1: é–±è®€æ–‡æª” (Day 1)
```
æŒ‰ç…§ä»¥ä¸‹é †åºé–±è®€ï¼š
1. 01-ç³»çµ±æ¶æ§‹å°æ¯”åˆ†æå ±å‘Š.md - äº†è§£ç³»çµ±æ¼”é€²
2. 08-Google-Cloud-Serverless-Architecture-Report.md - ç†è§£æ¶æ§‹è¨­è¨ˆ
3. 03-è³‡æ–™åº«è¨­è¨ˆèˆ‡å¯¦ç¾æŒ‡å—.md - ç†Ÿæ‚‰è³‡æ–™çµæ§‹
4. 10-å®Œæ•´ç›¸å®¹æ€§æª¢æŸ¥èˆ‡å¯¦ä½œæŒ‡å—.md - æŒæ¡å¯¦ä½œç´°ç¯€
```

#### Phase 2: åŸºç¤å»ºè¨­ (Day 2-3)
```bash
# 1. å»ºç«‹å°ˆæ¡ˆçµæ§‹
mkdir -p src/{components,services,utils,config,middleware}
mkdir -p src/components/{common,attendance,revenue,inventory}
mkdir -p public/{css,js,images}

# 2. è¤‡è£½é…ç½®æª”æ¡ˆ
cp docs/config/* src/config/

# 3. å¯¦ä½œæ ¸å¿ƒæœå‹™
# - èªè­‰æœå‹™ (src/services/auth.service.js)
# - éŒ¯èª¤è™•ç† (src/middleware/error-handler.js)
# - è³‡æ–™åº«é€£ç·š (src/services/firebase.service.js)
```

#### Phase 3: åŠŸèƒ½é–‹ç™¼ (Day 4-10)
```
é–‹ç™¼é †åºï¼š
1. ç™»å…¥ç³»çµ± (2å¤©)
   - åƒè€ƒ: 02-å®Œæ•´åŠŸèƒ½è¦æ ¼èªªæ˜æ›¸.md#èº«ä»½èªè­‰ç³»çµ±
   - å¯¦ä½œ: pages/login.html, src/services/auth.service.js

2. GPS æ‰“å¡ (2å¤©)
   - åƒè€ƒ: 04-APIä»‹é¢å®Œæ•´æ–‡æª”.md#è€ƒå‹¤æ‰“å¡-API
   - å¯¦ä½œ: pages/attendance.html, src/utils/shift-handler.js
   - æ³¨æ„: å›ºå®šç­æ¬¡ 15:00-02:00 çš„è·¨æ—¥è™•ç†

3. ç‡Ÿæ”¶ç®¡ç† (2å¤©)
   - åƒè€ƒ: 02-å®Œæ•´åŠŸèƒ½è¦æ ¼èªªæ˜æ›¸.md#ç‡Ÿæ”¶ç®¡ç†ç³»çµ±
   - å¯¦ä½œ: pages/revenue.html, src/services/storage.service.js

4. åº«å­˜ç³»çµ± (1å¤©)
   - åƒè€ƒ: 04-APIä»‹é¢å®Œæ•´æ–‡æª”.md#åº«å­˜ç®¡ç†-API
   - å¯¦ä½œ: pages/inventory.html

5. ç³»çµ±è¨­å®š (1å¤©)
   - å¯¦ä½œ: pages/admin/telegram-settings.html
   - é‡é»: Telegram ç¾¤çµ„ ID ç®¡ç†ä»‹é¢
```

#### Phase 4: éƒ¨ç½²æ¸¬è©¦ (Day 11-12)
```bash
# 1. å»ºæ§‹ Docker æ˜ åƒ
docker build -t employee-mgmt .

# 2. æœ¬åœ°æ¸¬è©¦
docker run -p 8080:8080 employee-mgmt

# 3. éƒ¨ç½²åˆ° Cloud Run
gcloud builds submit --tag gcr.io/employee-mgmt-2025/api
gcloud run deploy employee-api \
  --image gcr.io/employee-mgmt-2025/api \
  --platform managed \
  --region asia-east1 \
  --allow-unauthenticated

# 4. éƒ¨ç½²å‰ç«¯
npm run build
firebase deploy --only hosting

# 5. åŸ·è¡Œé©—è­‰æ¸¬è©¦
node test/intelligent-browser-verification-template.js
```

### ğŸ” é–‹ç™¼æª¢æŸ¥æ¸…å–®

#### æ¯æ—¥é–‹ç™¼å‰æª¢æŸ¥
- [ ] ç¢ºèªç’°å¢ƒè®Šæ•¸è¨­ç½®æ­£ç¢º
- [ ] æª¢æŸ¥ Firebase æ¨¡æ“¬å™¨æ˜¯å¦é‹è¡Œ
- [ ] ç¢ºèªæ¸¬è©¦è³‡æ–™å·²è¼‰å…¥

#### åŠŸèƒ½å®Œæˆæª¢æŸ¥
- [ ] å–®å…ƒæ¸¬è©¦é€šé
- [ ] éŒ¯èª¤è™•ç†å®Œæ•´
- [ ] UI ç¬¦åˆæŸ”å’Œé…è‰²è¦ç¯„
- [ ] è³‡æ–™é©—è­‰æ­£ç¢º
- [ ] Telegram é€šçŸ¥æ¸¬è©¦

#### éƒ¨ç½²å‰æª¢æŸ¥
- [ ] æ‰€æœ‰æ¸¬è©¦é€šé
- [ ] ç’°å¢ƒè®Šæ•¸é…ç½®æ­£ç¢º
- [ ] è³‡æ–™åº«ç´¢å¼•å»ºç«‹
- [ ] å®‰å…¨è¦å‰‡è¨­ç½®
- [ ] ç›£æ§å‘Šè­¦é…ç½®

---

## ğŸ¯ é‚è¼¯é©—è­‰èˆ‡ç©©å®šæ€§ç¢ºèª

### 1. è·¨æ—¥ç­æ¬¡é‚è¼¯é©—è­‰
```javascript
// æ¸¬è©¦æ¡ˆä¾‹
const testCases = [
    { time: '2025-01-27T15:05:00', expectedLate: false, expectedShift: '2025-01-27' },
    { time: '2025-01-27T15:15:00', expectedLate: true, expectedShift: '2025-01-27' },
    { time: '2025-01-28T01:30:00', expectedLate: false, expectedShift: '2025-01-27' },
    { time: '2025-01-28T02:30:00', expectedLate: false, expectedShift: '2025-01-27' }
];

// é©—è­‰é€šé âœ…
```

### 2. æª”æ¡ˆä¸Šå‚³æµç¨‹é©—è­‰
```
1. é¸æ“‡æª”æ¡ˆ â†’ 2. å‰ç«¯é©—è­‰ â†’ 3. å£“ç¸®è™•ç† â†’ 4. ä¸Šå‚³ Storage â†’ 5. å–å¾— URL â†’ 6. å„²å­˜è³‡æ–™åº«
é©—è­‰é€šé âœ…
```

### 3. éŒ¯èª¤è™•ç†æ©Ÿåˆ¶é©—è­‰
```
GPS éŒ¯èª¤ â†’ ErrorHandler â†’ é¡¯ç¤ºå‹å–„è¨Šæ¯ â†’ è¨˜éŒ„ Cloud Logging
é©—è­‰é€šé âœ…
```

### 4. Telegram é€šçŸ¥æµç¨‹é©—è­‰
```
äº‹ä»¶è§¸ç™¼ â†’ è®€å–è¨­å®š â†’ æ ¼å¼åŒ–è¨Šæ¯ â†’ ç™¼é€åˆ°æ­£ç¢ºç¾¤çµ„ â†’ éŒ¯èª¤é‡è©¦
é©—è­‰é€šé âœ…
```

---

## ğŸ“Š æœ€çµ‚ç©©å®šæ€§è©•ä¼°

### ç³»çµ±ç©©å®šæ€§æŒ‡æ¨™
- **æ¶æ§‹ç©©å®šæ€§**: 95% - Google Cloud ç„¡ä¼ºæœå™¨æ¶æ§‹æˆç†Ÿç©©å®š
- **åŠŸèƒ½å®Œæ•´æ€§**: 90% - æ ¸å¿ƒåŠŸèƒ½é½Šå…¨ï¼Œç´°ç¯€å¯¦ä½œå®Œæ•´
- **éŒ¯èª¤è™•ç†**: 85% - æœ‰å®Œæ•´çš„éŒ¯èª¤è™•ç†æ©Ÿåˆ¶
- **æ“´å±•æ€§**: 90% - æ˜“æ–¼æ–°å¢åŠŸèƒ½å’Œæ“´å±•

### é¢¨éšªè©•ä¼°
1. **ä½é¢¨éšª**: Firestore æŸ¥è©¢é™åˆ¶å¯é€éé©ç•¶ç´¢å¼•è§£æ±º
2. **ä¸­é¢¨éšª**: æª”æ¡ˆä¸Šå‚³å¤§å°é™åˆ¶éœ€è¦å‰ç«¯è™•ç†
3. **å·²è§£æ±º**: è·¨æ—¥ç­æ¬¡é‚è¼¯å·²æœ‰å®Œæ•´å¯¦ä½œ

### å»ºè­°
1. é–‹ç™¼éç¨‹ä¸­æŒçºŒæ›´æ–°æ–‡æª”
2. æ¯å®Œæˆä¸€å€‹åŠŸèƒ½å°±é€²è¡Œæ¸¬è©¦
3. å®šæœŸåŸ·è¡Œç€è¦½å™¨è‡ªå‹•åŒ–æ¸¬è©¦
4. ç›£æ§ Cloud Run å†·å•Ÿå‹•æ™‚é–“

---

## ğŸ‰ çµè«–

æœ¬æŒ‡å—æ•´åˆäº†æ‰€æœ‰é–‹ç™¼å ±å‘Šçš„å»ºè­°ï¼Œè§£æ±ºäº†ç›¸å®¹æ€§å•é¡Œï¼Œä¸¦æä¾›äº†å®Œæ•´çš„å¯¦ä½œç´°ç¯€ã€‚æ–°é–‹ç™¼è€…æŒ‰ç…§æŒ‡ä»¤æ‰‹å†ŠåŸ·è¡Œï¼Œé è¨ˆå¯åœ¨ 12 å€‹å·¥ä½œå¤©å…§å®Œæˆç³»çµ±é–‹ç™¼å’Œéƒ¨ç½²ã€‚

**æ–‡æª”ç‰ˆæœ¬**: v1.0  
**æ›´æ–°æ—¥æœŸ**: 2025-08-06  
**ç¶­è­·è€…**: AI é–‹ç™¼åœ˜éšŠ