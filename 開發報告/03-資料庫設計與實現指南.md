# 💾 企業員工管理系統 - 資料庫設計與實現指南

## 📋 文檔概述

本指南提供完整的資料庫設計方案，包含：
- 資料表結構定義
- 關聯關係設計
- 索引優化策略
- 資料遷移方案
- 效能調優建議

---

## 🏗️ 資料庫架構總覽

### 技術選型對比

| 方案 | 優點 | 缺點 | 適用場景 |
|------|------|------|----------|
| **記憶體模擬** | 開發快速、無需設置 | 資料不持久、容量限制 | 開發測試 |
| **Google Sheets** | 免費、易維護、自動備份 | 查詢效能低、並發限制 | 小型企業 |
| **PostgreSQL** | 高效能、ACID、擴展性強 | 需要維護、成本較高 | 中大型企業 |
| **MongoDB** | 靈活schema、水平擴展 | 事務支援弱、一致性 | 大數據場景 |

### 推薦架構
```
開發環境：記憶體模擬
測試環境：SQLite
生產環境：PostgreSQL + Redis快取
```

---

## 📊 核心資料表設計

### 1. 員工資料表 (employees)

```sql
CREATE TABLE employees (
    id SERIAL PRIMARY KEY,
    employee_code VARCHAR(20) UNIQUE NOT NULL,
    username VARCHAR(50) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    
    -- 基本資料
    name VARCHAR(100) NOT NULL,
    id_number VARCHAR(20) UNIQUE NOT NULL,
    birth_date DATE NOT NULL,
    gender VARCHAR(10) CHECK (gender IN ('男', '女', '其他')),
    
    -- 聯絡資訊
    phone VARCHAR(20) NOT NULL,
    email VARCHAR(100),
    address TEXT,
    line_id VARCHAR(50),
    
    -- 緊急聯絡人
    emergency_contact VARCHAR(100),
    emergency_phone VARCHAR(20),
    emergency_relationship VARCHAR(50),
    
    -- 工作資訊
    department VARCHAR(50) NOT NULL,
    position VARCHAR(50) NOT NULL,
    role VARCHAR(20) NOT NULL CHECK (role IN ('employee', 'manager', 'admin')),
    store_name VARCHAR(50) NOT NULL,
    hire_date DATE NOT NULL,
    
    -- 薪資資訊
    base_salary DECIMAL(10, 2),
    
    -- 系統資訊
    status VARCHAR(20) DEFAULT 'active' CHECK (status IN ('active', 'inactive', 'suspended')),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_login_at TIMESTAMP,
    
    -- 統計資訊
    total_work_days INTEGER DEFAULT 0,
    current_position_days INTEGER DEFAULT 0,
    
    -- 駕照資訊
    license_type VARCHAR(50),
    
    -- 索引
    INDEX idx_employee_code (employee_code),
    INDEX idx_username (username),
    INDEX idx_department_store (department, store_name),
    INDEX idx_status (status)
);

-- 觸發器：自動更新 updated_at
CREATE TRIGGER update_employees_updated_at 
    BEFORE UPDATE ON employees 
    FOR EACH ROW 
    SET NEW.updated_at = CURRENT_TIMESTAMP;
```

### 2. 考勤記錄表 (attendance_records)

```sql
CREATE TABLE attendance_records (
    id SERIAL PRIMARY KEY,
    employee_id INTEGER NOT NULL,
    
    -- 打卡資訊
    clock_type VARCHAR(10) NOT NULL CHECK (clock_type IN ('上班', '下班')),
    clock_time TIMESTAMP NOT NULL,
    store_name VARCHAR(50) NOT NULL,
    
    -- GPS資訊
    gps_latitude DECIMAL(10, 8),
    gps_longitude DECIMAL(11, 8),
    gps_accuracy DECIMAL(6, 2),
    distance_meters DECIMAL(8, 2),
    
    -- 設備資訊
    device_fingerprint VARCHAR(255),
    ip_address VARCHAR(45),
    user_agent TEXT,
    
    -- 狀態資訊
    status VARCHAR(20) DEFAULT '正常' CHECK (status IN ('正常', '遲到', '早退', '異常')),
    late_minutes INTEGER DEFAULT 0,
    anomaly_reason TEXT,
    
    -- 時間戳記
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- 外鍵約束
    FOREIGN KEY (employee_id) REFERENCES employees(id) ON DELETE CASCADE,
    
    -- 索引
    INDEX idx_employee_date (employee_id, clock_time),
    INDEX idx_clock_type (clock_type),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at)
);

-- 複合唯一索引：防止重複打卡
CREATE UNIQUE INDEX idx_unique_clock 
    ON attendance_records(employee_id, DATE(clock_time), clock_type);
```

### 3. 營收記錄表 (revenue_records)

```sql
CREATE TABLE revenue_records (
    id SERIAL PRIMARY KEY,
    employee_id INTEGER NOT NULL,
    
    -- 營收資訊
    revenue_date DATE NOT NULL,
    store_name VARCHAR(50) NOT NULL,
    
    -- 收入明細 (JSON格式)
    revenue_details JSON NOT NULL DEFAULT '{}',
    /* 格式範例：
    {
        "現場": 35000,
        "外送": 15000,
        "外帶": 8000,
        "其他": 2000
    }
    */
    
    -- 支出明細 (JSON格式)
    expense_details JSON NOT NULL DEFAULT '{}',
    /* 格式範例：
    {
        "食材": 18000,
        "人事": 12000,
        "水電": 3000,
        "其他": 2000
    }
    */
    
    -- 計算欄位
    total_revenue DECIMAL(12, 2) GENERATED ALWAYS AS (
        CAST(revenue_details->>'現場' AS DECIMAL) +
        CAST(revenue_details->>'外送' AS DECIMAL) +
        CAST(revenue_details->>'外帶' AS DECIMAL) +
        CAST(revenue_details->>'其他' AS DECIMAL)
    ) STORED,
    
    total_expense DECIMAL(12, 2) GENERATED ALWAYS AS (
        CAST(expense_details->>'食材' AS DECIMAL) +
        CAST(expense_details->>'人事' AS DECIMAL) +
        CAST(expense_details->>'水電' AS DECIMAL) +
        CAST(expense_details->>'其他' AS DECIMAL)
    ) STORED,
    
    net_revenue DECIMAL(12, 2) GENERATED ALWAYS AS (
        total_revenue - total_expense
    ) STORED,
    
    -- 獎金資訊
    bonus_rate DECIMAL(5, 2),
    bonus_amount DECIMAL(10, 2),
    is_target_achieved BOOLEAN DEFAULT FALSE,
    
    -- 照片證明
    photo_urls JSON,
    
    -- 狀態資訊
    status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'approved', 'rejected')),
    approved_by INTEGER,
    approved_at TIMESTAMP,
    
    -- 備註
    notes TEXT,
    
    -- 時間戳記
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- 外鍵約束
    FOREIGN KEY (employee_id) REFERENCES employees(id) ON DELETE CASCADE,
    FOREIGN KEY (approved_by) REFERENCES employees(id),
    
    -- 索引
    INDEX idx_revenue_date (revenue_date),
    INDEX idx_employee_month (employee_id, DATE_TRUNC('month', revenue_date)),
    INDEX idx_store_date (store_name, revenue_date),
    UNIQUE INDEX idx_unique_daily_revenue (employee_id, revenue_date, store_name)
);
```

### 4. 庫存管理表 (inventory_items)

```sql
CREATE TABLE inventory_items (
    id SERIAL PRIMARY KEY,
    
    -- 品項資訊
    item_code VARCHAR(50) UNIQUE NOT NULL,
    item_name VARCHAR(100) NOT NULL,
    category VARCHAR(50) NOT NULL,
    unit VARCHAR(20) NOT NULL,
    
    -- 庫存資訊
    current_quantity DECIMAL(10, 2) NOT NULL DEFAULT 0,
    min_quantity DECIMAL(10, 2) NOT NULL DEFAULT 0,
    max_quantity DECIMAL(10, 2),
    
    -- 價格資訊
    unit_price DECIMAL(10, 2),
    last_purchase_price DECIMAL(10, 2),
    average_price DECIMAL(10, 2),
    
    -- 供應商資訊
    primary_supplier VARCHAR(100),
    supplier_contact VARCHAR(100),
    
    -- 狀態資訊
    is_active BOOLEAN DEFAULT TRUE,
    last_order_date DATE,
    last_receive_date DATE,
    
    -- 時間戳記
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- 索引
    INDEX idx_item_name (item_name),
    INDEX idx_category (category),
    INDEX idx_active (is_active)
);
```

### 5. 叫貨記錄表 (order_records)

```sql
CREATE TABLE order_records (
    id SERIAL PRIMARY KEY,
    order_number VARCHAR(50) UNIQUE NOT NULL,
    employee_id INTEGER NOT NULL,
    
    -- 訂單資訊
    order_date DATE NOT NULL,
    store_name VARCHAR(50) NOT NULL,
    supplier VARCHAR(100) NOT NULL,
    
    -- 訂單明細 (JSON格式)
    order_items JSON NOT NULL,
    /* 格式範例：
    [
        {
            "item_id": 1,
            "item_name": "雞胸肉",
            "quantity": 50,
            "unit": "公斤",
            "unit_price": 120,
            "subtotal": 6000
        }
    ]
    */
    
    -- 金額資訊
    total_amount DECIMAL(12, 2) NOT NULL,
    
    -- 交貨資訊
    expected_delivery DATE,
    actual_delivery DATE,
    received_by INTEGER,
    
    -- 狀態資訊
    status VARCHAR(20) DEFAULT 'pending' CHECK (
        status IN ('pending', 'confirmed', 'shipped', 'received', 'cancelled')
    ),
    
    -- 異常處理
    has_anomaly BOOLEAN DEFAULT FALSE,
    anomaly_type VARCHAR(50),
    anomaly_description TEXT,
    
    -- 照片證明
    order_photo_url TEXT,
    receipt_photo_url TEXT,
    
    -- 備註
    notes TEXT,
    
    -- 時間戳記
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- 外鍵約束
    FOREIGN KEY (employee_id) REFERENCES employees(id),
    FOREIGN KEY (received_by) REFERENCES employees(id),
    
    -- 索引
    INDEX idx_order_date (order_date),
    INDEX idx_status (status),
    INDEX idx_supplier (supplier),
    INDEX idx_store_date (store_name, order_date)
);
```

### 6. 排班記錄表 (schedule_records)

```sql
-- 員工排班申請表
CREATE TABLE schedule_requests (
    id SERIAL PRIMARY KEY,
    employee_id INTEGER NOT NULL,
    
    -- 排班資訊
    schedule_month DATE NOT NULL,
    store_name VARCHAR(50) NOT NULL,
    
    -- 偏好設定 (JSON格式)
    preferences JSON NOT NULL,
    /* 格式範例：
    {
        "preferred_dates": ["2025-01-05", "2025-01-12"],
        "preferred_shifts": ["morning", "evening"],
        "avoid_dates": ["2025-01-20"],
        "max_hours_per_week": 40
    }
    */
    
    -- 狀態資訊
    status VARCHAR(20) DEFAULT 'pending' CHECK (
        status IN ('pending', 'processed', 'cancelled')
    ),
    
    -- 時間戳記
    submitted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    processed_at TIMESTAMP,
    
    -- 外鍵約束
    FOREIGN KEY (employee_id) REFERENCES employees(id),
    
    -- 索引
    INDEX idx_employee_month (employee_id, schedule_month),
    UNIQUE INDEX idx_unique_request (employee_id, schedule_month)
);

-- 正式排班表
CREATE TABLE schedules (
    id SERIAL PRIMARY KEY,
    employee_id INTEGER NOT NULL,
    
    -- 排班資訊
    schedule_date DATE NOT NULL,
    store_name VARCHAR(50) NOT NULL,
    shift_type VARCHAR(20) NOT NULL CHECK (
        shift_type IN ('morning', 'afternoon', 'evening', 'night')
    ),
    
    -- 時間資訊
    start_time TIME NOT NULL,
    end_time TIME NOT NULL,
    break_minutes INTEGER DEFAULT 60,
    
    -- 狀態資訊
    is_holiday BOOLEAN DEFAULT FALSE,
    holiday_type VARCHAR(50),
    is_confirmed BOOLEAN DEFAULT FALSE,
    
    -- 調班資訊
    original_employee_id INTEGER,
    swap_reason TEXT,
    
    -- 管理資訊
    created_by INTEGER NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- 外鍵約束
    FOREIGN KEY (employee_id) REFERENCES employees(id),
    FOREIGN KEY (original_employee_id) REFERENCES employees(id),
    FOREIGN KEY (created_by) REFERENCES employees(id),
    
    -- 索引
    INDEX idx_employee_date (employee_id, schedule_date),
    INDEX idx_store_date (store_name, schedule_date),
    UNIQUE INDEX idx_unique_schedule (employee_id, schedule_date, shift_type)
);
```

### 7. 升遷投票表 (promotion_votes)

```sql
-- 升遷申請主表
CREATE TABLE promotion_applications (
    id SERIAL PRIMARY KEY,
    candidate_id INTEGER NOT NULL,
    
    -- 升遷資訊
    current_position VARCHAR(50) NOT NULL,
    target_position VARCHAR(50) NOT NULL,
    
    -- 申請資訊
    application_reason TEXT NOT NULL,
    achievements TEXT,
    
    -- 投票設定
    voting_start_date TIMESTAMP NOT NULL,
    voting_end_date TIMESTAMP NOT NULL,
    required_approve_votes INTEGER NOT NULL,
    
    -- 投票統計
    total_approve_votes INTEGER DEFAULT 0,
    total_reject_votes INTEGER DEFAULT 0,
    total_abstain_votes INTEGER DEFAULT 0,
    
    -- 狀態資訊
    status VARCHAR(20) DEFAULT 'voting' CHECK (
        status IN ('voting', 'approved', 'rejected', 'cancelled')
    ),
    
    -- 結果資訊
    final_result VARCHAR(20),
    result_date TIMESTAMP,
    result_notes TEXT,
    
    -- 管理資訊
    initiated_by INTEGER NOT NULL,
    approved_by INTEGER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- 外鍵約束
    FOREIGN KEY (candidate_id) REFERENCES employees(id),
    FOREIGN KEY (initiated_by) REFERENCES employees(id),
    FOREIGN KEY (approved_by) REFERENCES employees(id),
    
    -- 索引
    INDEX idx_candidate (candidate_id),
    INDEX idx_status (status),
    INDEX idx_voting_period (voting_start_date, voting_end_date)
);

-- 投票記錄表
CREATE TABLE promotion_vote_records (
    id SERIAL PRIMARY KEY,
    application_id INTEGER NOT NULL,
    
    -- 投票資訊（匿名）
    anonymous_voter_id VARCHAR(255) NOT NULL, -- 加密的投票者ID
    vote_decision VARCHAR(20) NOT NULL CHECK (
        vote_decision IN ('approve', 'reject', 'abstain')
    ),
    vote_comment TEXT,
    
    -- 防作弊資訊
    ip_address_hash VARCHAR(255),
    device_fingerprint_hash VARCHAR(255),
    
    -- 時間戳記
    voted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- 外鍵約束
    FOREIGN KEY (application_id) REFERENCES promotion_applications(id),
    
    -- 索引
    INDEX idx_application (application_id),
    UNIQUE INDEX idx_unique_vote (application_id, anonymous_voter_id)
);
```

### 8. 維修記錄表 (maintenance_records)

```sql
CREATE TABLE maintenance_records (
    id SERIAL PRIMARY KEY,
    ticket_number VARCHAR(50) UNIQUE NOT NULL,
    reported_by INTEGER NOT NULL,
    
    -- 報修資訊
    report_date TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    store_name VARCHAR(50) NOT NULL,
    equipment_type VARCHAR(50) NOT NULL,
    equipment_name VARCHAR(100) NOT NULL,
    
    -- 問題描述
    issue_description TEXT NOT NULL,
    priority VARCHAR(20) NOT NULL CHECK (
        priority IN ('low', 'medium', 'high', 'urgent')
    ),
    
    -- 照片證明
    issue_photos JSON,
    
    -- 處理資訊
    status VARCHAR(20) DEFAULT 'reported' CHECK (
        status IN ('reported', 'assigned', 'in_progress', 'completed', 'verified')
    ),
    assigned_to VARCHAR(100),
    assigned_at TIMESTAMP,
    
    -- 維修資訊
    repair_start_time TIMESTAMP,
    repair_end_time TIMESTAMP,
    repair_description TEXT,
    parts_replaced TEXT,
    
    -- 成本資訊
    labor_cost DECIMAL(10, 2),
    parts_cost DECIMAL(10, 2),
    total_cost DECIMAL(10, 2) GENERATED ALWAYS AS (
        COALESCE(labor_cost, 0) + COALESCE(parts_cost, 0)
    ) STORED,
    
    -- 驗收資訊
    verified_by INTEGER,
    verified_at TIMESTAMP,
    verification_notes TEXT,
    
    -- 時間戳記
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- 外鍵約束
    FOREIGN KEY (reported_by) REFERENCES employees(id),
    FOREIGN KEY (verified_by) REFERENCES employees(id),
    
    -- 索引
    INDEX idx_status (status),
    INDEX idx_priority (priority),
    INDEX idx_store_equipment (store_name, equipment_type),
    INDEX idx_report_date (report_date)
);
```

### 9. 公告系統表 (announcements)

```sql
CREATE TABLE announcements (
    id SERIAL PRIMARY KEY,
    
    -- 公告資訊
    title VARCHAR(200) NOT NULL,
    content TEXT NOT NULL,
    type VARCHAR(50) NOT NULL CHECK (
        type IN ('notice', 'policy', 'event', 'emergency', 'other')
    ),
    priority VARCHAR(20) NOT NULL CHECK (
        priority IN ('low', 'normal', 'high', 'urgent')
    ),
    
    -- 發布資訊
    author_id INTEGER NOT NULL,
    publish_date TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    expire_date TIMESTAMP,
    
    -- 目標對象
    target_departments JSON, -- ["IT部門", "管理部門"]
    target_stores JSON,      -- ["內壢店", "桃園店"]
    target_roles JSON,       -- ["employee", "manager"]
    
    -- 狀態資訊
    is_active BOOLEAN DEFAULT TRUE,
    is_pinned BOOLEAN DEFAULT FALSE,
    
    -- 統計資訊
    view_count INTEGER DEFAULT 0,
    
    -- 附件
    attachments JSON,
    
    -- 時間戳記
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- 外鍵約束
    FOREIGN KEY (author_id) REFERENCES employees(id),
    
    -- 索引
    INDEX idx_active_pinned (is_active, is_pinned),
    INDEX idx_publish_expire (publish_date, expire_date),
    INDEX idx_type_priority (type, priority)
);

-- 公告已讀記錄表
CREATE TABLE announcement_reads (
    id SERIAL PRIMARY KEY,
    announcement_id INTEGER NOT NULL,
    employee_id INTEGER NOT NULL,
    read_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- 外鍵約束
    FOREIGN KEY (announcement_id) REFERENCES announcements(id) ON DELETE CASCADE,
    FOREIGN KEY (employee_id) REFERENCES employees(id) ON DELETE CASCADE,
    
    -- 索引
    UNIQUE INDEX idx_unique_read (announcement_id, employee_id)
);
```

### 10. 系統設定表 (system_settings)

```sql
CREATE TABLE system_settings (
    id SERIAL PRIMARY KEY,
    
    -- 設定資訊
    category VARCHAR(50) NOT NULL,
    setting_key VARCHAR(100) NOT NULL,
    setting_value TEXT NOT NULL,
    value_type VARCHAR(20) NOT NULL CHECK (
        value_type IN ('string', 'number', 'boolean', 'json', 'date')
    ),
    
    -- 說明資訊
    description TEXT,
    default_value TEXT,
    
    -- 驗證規則
    validation_rules JSON,
    
    -- 管理資訊
    is_editable BOOLEAN DEFAULT TRUE,
    last_modified_by INTEGER,
    last_modified_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- 外鍵約束
    FOREIGN KEY (last_modified_by) REFERENCES employees(id),
    
    -- 索引
    UNIQUE INDEX idx_unique_setting (category, setting_key),
    INDEX idx_category (category)
);

-- 預設系統設定
INSERT INTO system_settings (category, setting_key, setting_value, value_type, description) VALUES
('attendance', 'gps_radius', '100', 'number', 'GPS打卡允許半徑（公尺）'),
('attendance', 'late_grace_minutes', '10', 'number', '遲到寬限時間（分鐘）'),
('revenue', 'bonus_thresholds', '[{"rate": 1.0, "bonus": 0.01}, {"rate": 1.1, "bonus": 0.02}]', 'json', '獎金門檻設定'),
('maintenance', 'urgent_priority_hours', '4', 'number', '緊急維修回應時間（小時）'),
('notification', 'telegram_boss_group', '-1002658082392', 'string', '老闆Telegram群組ID'),
('notification', 'telegram_employee_group', '-1002658082393', 'string', '員工Telegram群組ID');
```

### 11. 操作日誌表 (audit_logs)

```sql
CREATE TABLE audit_logs (
    id SERIAL PRIMARY KEY,
    
    -- 操作資訊
    user_id INTEGER,
    action_type VARCHAR(50) NOT NULL,
    table_name VARCHAR(50),
    record_id INTEGER,
    
    -- 變更資訊
    old_values JSON,
    new_values JSON,
    
    -- 請求資訊
    ip_address VARCHAR(45),
    user_agent TEXT,
    request_method VARCHAR(10),
    request_url TEXT,
    
    -- 結果資訊
    is_success BOOLEAN DEFAULT TRUE,
    error_message TEXT,
    
    -- 時間戳記
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- 外鍵約束（允許NULL以記錄系統操作）
    FOREIGN KEY (user_id) REFERENCES employees(id) ON DELETE SET NULL,
    
    -- 索引
    INDEX idx_user_action (user_id, action_type),
    INDEX idx_table_record (table_name, record_id),
    INDEX idx_created_at (created_at)
);
```

---

## 🔗 資料表關聯關係

### ER圖說明
```
employees (1) ──────< (N) attendance_records
    │
    ├──────< (N) revenue_records
    │
    ├──────< (N) order_records
    │
    ├──────< (N) schedule_requests
    │
    ├──────< (N) schedules
    │
    ├──────< (N) promotion_applications (as candidate)
    │
    ├──────< (N) promotion_applications (as initiator)
    │
    ├──────< (N) maintenance_records (as reporter)
    │
    ├──────< (N) announcements (as author)
    │
    └──────< (N) audit_logs

promotion_applications (1) ──────< (N) promotion_vote_records

announcements (1) ──────< (N) announcement_reads

inventory_items ←──── order_records (through JSON)
```

---

## 🚀 效能優化策略

### 1. 索引設計原則

```sql
-- 複合索引範例
CREATE INDEX idx_attendance_employee_month 
    ON attendance_records(employee_id, DATE_TRUNC('month', clock_time));

-- 部分索引範例（只索引活躍員工）
CREATE INDEX idx_active_employees 
    ON employees(username) 
    WHERE status = 'active';

-- 函數索引範例
CREATE INDEX idx_revenue_month 
    ON revenue_records(DATE_TRUNC('month', revenue_date));
```

### 2. 查詢優化建議

```sql
-- 使用 WITH 子句提高可讀性和效能
WITH monthly_revenue AS (
    SELECT 
        employee_id,
        DATE_TRUNC('month', revenue_date) as month,
        SUM(net_revenue) as total_revenue
    FROM revenue_records
    WHERE status = 'approved'
    GROUP BY employee_id, DATE_TRUNC('month', revenue_date)
)
SELECT 
    e.name,
    mr.month,
    mr.total_revenue,
    RANK() OVER (PARTITION BY mr.month ORDER BY mr.total_revenue DESC) as rank
FROM monthly_revenue mr
JOIN employees e ON e.id = mr.employee_id
WHERE mr.month = DATE_TRUNC('month', CURRENT_DATE);
```

### 3. 分區策略

```sql
-- 按月分區考勤記錄表
CREATE TABLE attendance_records_2025_01 PARTITION OF attendance_records
    FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');

CREATE TABLE attendance_records_2025_02 PARTITION OF attendance_records
    FOR VALUES FROM ('2025-02-01') TO ('2025-03-01');
```

---

## 🔄 資料遷移方案

### 從記憶體到PostgreSQL

```javascript
// 遷移腳本範例
async function migrateToPostgreSQL() {
    const memoryData = getCurrentMemoryData();
    
    // 1. 建立連接
    const pg = new Pool({
        connectionString: process.env.DATABASE_URL
    });
    
    // 2. 開始事務
    const client = await pg.connect();
    try {
        await client.query('BEGIN');
        
        // 3. 遷移員工資料
        for (const employee of memoryData.employees) {
            await client.query(`
                INSERT INTO employees (
                    username, password_hash, name, id_number,
                    department, position, role, store_name, hire_date
                ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
            `, [
                employee.username,
                await bcrypt.hash(employee.password, 10),
                employee.name,
                employee.idNumber,
                employee.department,
                employee.position,
                employee.role,
                employee.storeName,
                employee.hireDate
            ]);
        }
        
        // 4. 遷移其他資料表...
        
        await client.query('COMMIT');
    } catch (error) {
        await client.query('ROLLBACK');
        throw error;
    } finally {
        client.release();
    }
}
```

### 從Google Sheets到PostgreSQL

```javascript
// Google Sheets 遷移腳本
async function migrateFromGoogleSheets() {
    const sheets = google.sheets({ version: 'v4', auth });
    
    // 1. 讀取員工資料
    const employeesResponse = await sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: 'Employees!A2:U'
    });
    
    const employees = employeesResponse.data.values;
    
    // 2. 轉換並插入
    for (const row of employees) {
        const employee = {
            employee_code: row[0],
            name: row[1],
            id_number: row[2],
            birth_date: row[3],
            gender: row[4],
            // ... 其他欄位映射
        };
        
        await insertEmployee(employee);
    }
}
```

---

## 📊 監控與維護

### 1. 效能監控查詢

```sql
-- 查詢慢查詢
SELECT 
    query,
    mean_exec_time,
    calls,
    total_exec_time
FROM pg_stat_statements
WHERE mean_exec_time > 100
ORDER BY mean_exec_time DESC
LIMIT 20;

-- 查詢表大小
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;

-- 查詢索引使用情況
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
ORDER BY idx_scan;
```

### 2. 定期維護任務

```sql
-- 每日執行
VACUUM ANALYZE;

-- 每週執行
REINDEX DATABASE employee_management;

-- 每月執行
-- 清理舊的審計日誌
DELETE FROM audit_logs 
WHERE created_at < CURRENT_DATE - INTERVAL '90 days';

-- 清理過期公告
UPDATE announcements 
SET is_active = FALSE 
WHERE expire_date < CURRENT_DATE AND is_active = TRUE;
```

---

## 🔒 安全建議

### 1. 資料加密

```sql
-- 使用 pgcrypto 擴展加密敏感資料
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- 加密身分證號
UPDATE employees 
SET id_number = pgp_sym_encrypt(id_number, 'encryption_key');

-- 查詢時解密
SELECT 
    id,
    name,
    pgp_sym_decrypt(id_number::bytea, 'encryption_key') as id_number
FROM employees;
```

### 2. 行級安全性

```sql
-- 啟用行級安全性
ALTER TABLE revenue_records ENABLE ROW LEVEL SECURITY;

-- 創建策略：員工只能看到自己的營收記錄
CREATE POLICY employee_revenue_policy ON revenue_records
    FOR ALL
    TO employee_role
    USING (employee_id = current_user_id());

-- 管理員可以看到所有記錄
CREATE POLICY admin_revenue_policy ON revenue_records
    FOR ALL
    TO admin_role
    USING (true);
```

---

## 📈 總結

本資料庫設計指南提供了：

1. **完整的資料表結構**：11個核心資料表，涵蓋所有業務需求
2. **優化的索引策略**：提升查詢效能
3. **清晰的關聯關係**：確保資料完整性
4. **實用的遷移方案**：支援多種資料來源
5. **全面的安全機制**：保護敏感資料

這份設計可以直接用於生產環境的資料庫建置。

---

**文檔版本**: v1.0  
**更新日期**: 2025-01-10  
**資料庫架構師**: AI開發團隊