# 📚 企業員工管理系統 - 完整功能規格說明書

## 📋 文檔說明

本文檔整合了所有版本的功能設計，提供每個模組的詳細規格說明，包含：
- 功能描述
- 業務邏輯
- 資料流程
- API規格
- UI/UX設計
- 錯誤處理

---

## 🔐 1. 身份認證系統

### 1.1 登入功能

#### 功能描述
支援兩種登入方式，提供安全的身份驗證機制。

#### 登入方式
1. **員工編號 + 密碼**
2. **身分證號 + 密碼**

#### API 端點
```http
POST /api/auth/login
```

#### 請求格式
```json
{
  "username": "john.doe 或 A123456789",
  "password": "password123"
}
```

#### 回應格式
```json
{
  "success": true,
  "token": "eyJhbGciOiJIUzI1NiIs...",
  "user": {
    "id": 1,
    "name": "約翰·多伊",
    "role": "employee",
    "department": "IT部門"
  }
}
```

#### 業務邏輯
```javascript
1. 驗證輸入格式
2. 查詢員工資料
3. 驗證密碼（應使用bcrypt）
4. 生成JWT token（有效期7天）
5. 記錄登入日誌
6. 返回用戶資訊
```

#### 錯誤處理
- `401`: 帳號或密碼錯誤
- `429`: 登入嘗試次數過多（5次/15分鐘）
- `500`: 系統錯誤

### 1.2 登出功能

#### API 端點
```http
POST /api/auth/logout
```

#### 業務邏輯
```javascript
1. 驗證token有效性
2. 將token加入黑名單
3. 清除會話資料
4. 記錄登出日誌
```

---

## ⏰ 2. 打卡系統

### 2.1 GPS打卡功能

#### 功能描述
使用GPS定位確保員工在指定範圍內打卡，並記錄設備指紋防止代打卡。

#### 打卡類型
- **上班打卡**
- **下班打卡**

#### API 端點
```http
POST /api/attendance/clock-in
POST /api/attendance/clock-out
```

#### 請求格式
```json
{
  "employeeId": 1,
  "type": "上班",
  "storeName": "內壢店",
  "gpsCoordinates": "24.9748412,121.2556713",
  "deviceFingerprint": "hash-string",
  "timestamp": "2025-01-10T09:00:00Z"
}
```

#### GPS驗證邏輯
```javascript
function validateLocation(userLat, userLng, storeLat, storeLng) {
  const R = 6371e3; // 地球半徑（米）
  const φ1 = userLat * Math.PI/180;
  const φ2 = storeLat * Math.PI/180;
  const Δφ = (storeLat - userLat) * Math.PI/180;
  const Δλ = (storeLng - userLng) * Math.PI/180;

  const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
            Math.cos(φ1) * Math.cos(φ2) *
            Math.sin(Δλ/2) * Math.sin(Δλ/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  const distance = R * c;

  return distance <= 100; // 100公尺內
}
```

#### 設備指紋生成
```javascript
function generateDeviceFingerprint() {
  const components = [
    navigator.userAgent,
    navigator.language,
    screen.width + 'x' + screen.height,
    screen.colorDepth,
    new Date().getTimezoneOffset()
  ];
  
  return CryptoJS.SHA256(components.join('|')).toString();
}
```

#### 遲到判定邏輯
```javascript
const workStartTime = "09:00";
const graceMinutes = 10;

function calculateLateMinutes(clockInTime, scheduledTime) {
  const actualTime = new Date(clockInTime);
  const scheduled = new Date(scheduledTime);
  const diffMinutes = (actualTime - scheduled) / 60000;
  
  return diffMinutes > graceMinutes ? Math.floor(diffMinutes) : 0;
}
```

#### Telegram 通知格式
```
🔔 打卡通知

員工：約翰·多伊
類型：上班打卡
時間：2025-01-10 09:05:23
地點：內壢店
狀態：✅ 正常
距離：25公尺
```

---

## 💰 3. 營收管理系統

### 3.1 營收記錄功能

#### 功能描述
記錄每日營業收支明細，自動計算獎金，支援多種收入類型。

#### API 端點
```http
POST /api/revenue/record
```

#### 請求格式
```json
{
  "date": "2025-01-10",
  "storeName": "內壢店",
  "revenue": {
    "現場": 35000,
    "外送": 15000,
    "外帶": 8000,
    "其他": 2000
  },
  "expenses": {
    "食材": 18000,
    "人事": 12000,
    "水電": 3000,
    "其他": 2000
  },
  "photos": ["base64_string1", "base64_string2"]
}
```

#### 獎金計算邏輯
```javascript
function calculateBonus(netRevenue, targetRevenue) {
  const bonusRates = [
    { threshold: 1.5, rate: 0.05 },  // 150%目標 = 5%獎金
    { threshold: 1.3, rate: 0.03 },  // 130%目標 = 3%獎金
    { threshold: 1.1, rate: 0.02 },  // 110%目標 = 2%獎金
    { threshold: 1.0, rate: 0.01 }   // 100%目標 = 1%獎金
  ];
  
  const achievementRate = netRevenue / targetRevenue;
  
  for (const bonus of bonusRates) {
    if (achievementRate >= bonus.threshold) {
      return netRevenue * bonus.rate;
    }
  }
  
  return 0;
}
```

#### 營收報表格式
```
📊 日營收報告 - 2025-01-10

【收入明細】
現場營業：NT$ 35,000
外送平台：NT$ 15,000
外帶自取：NT$ 8,000
其他收入：NT$ 2,000
────────────────
收入總計：NT$ 60,000

【支出明細】
食材成本：NT$ 18,000
人事費用：NT$ 12,000
水電瓦斯：NT$ 3,000
其他支出：NT$ 2,000
────────────────
支出總計：NT$ 35,000

【營運績效】
淨收入：NT$ 25,000
達成率：125%
獎金：NT$ 750
```

---

## 📦 4. 庫存叫貨系統

### 4.1 叫貨申請功能

#### 功能描述
管理庫存物品的訂購流程，追蹤到貨狀態，自動檢測異常。

#### API 端點
```http
POST /api/orders/create
GET /api/orders/list
PUT /api/orders/{id}/receive
```

#### 叫貨單格式
```json
{
  "orderDate": "2025-01-10",
  "storeName": "內壢店",
  "items": [
    {
      "itemId": 1,
      "itemName": "雞胸肉",
      "quantity": 50,
      "unit": "公斤",
      "unitPrice": 120,
      "supplier": "優質肉品"
    },
    {
      "itemId": 2,
      "itemName": "生菜",
      "quantity": 30,
      "unit": "公斤",
      "unitPrice": 80,
      "supplier": "新鮮蔬果"
    }
  ],
  "expectedDelivery": "2025-01-12",
  "notes": "請確保冷鏈運輸"
}
```

#### 異常檢測邏輯
```javascript
function detectOrderAnomalies(currentOrder, historicalOrders) {
  const anomalies = [];
  
  // 檢測數量異常（超過歷史平均值的150%）
  const avgQuantity = calculateAverage(historicalOrders, 'quantity');
  if (currentOrder.quantity > avgQuantity * 1.5) {
    anomalies.push({
      type: 'QUANTITY_SPIKE',
      message: `數量異常：${currentOrder.quantity} (平均：${avgQuantity})`
    });
  }
  
  // 檢測價格異常（超過歷史平均價格的120%）
  const avgPrice = calculateAverage(historicalOrders, 'unitPrice');
  if (currentOrder.unitPrice > avgPrice * 1.2) {
    anomalies.push({
      type: 'PRICE_INCREASE',
      message: `價格上漲：${currentOrder.unitPrice} (平均：${avgPrice})`
    });
  }
  
  // 檢測重複叫貨（24小時內相同品項）
  const recentOrder = findRecentOrder(historicalOrders, currentOrder.itemId, 24);
  if (recentOrder) {
    anomalies.push({
      type: 'DUPLICATE_ORDER',
      message: `24小時內重複叫貨`
    });
  }
  
  return anomalies;
}
```

---

## 📅 5. 排班管理系統

### 5.1 員工排班申請

#### 功能描述
員工自主選擇可上班時段，系統自動避免衝突，管理員最終分配。

#### 申請流程
```
員工選擇時段 → 系統驗證 → 儲存偏好 → 管理員分配 → 發布排班表
```

#### API 端點
```http
POST /api/schedules/request
GET /api/schedules/my-schedule
POST /api/schedules/admin/assign
```

#### 衝突檢測邏輯
```javascript
function detectScheduleConflicts(newSchedule, existingSchedules) {
  const conflicts = [];
  
  for (const existing of existingSchedules) {
    // 檢查時間重疊
    if (isTimeOverlap(newSchedule, existing)) {
      conflicts.push({
        type: 'TIME_OVERLAP',
        conflictWith: existing.employeeName,
        time: `${existing.date} ${existing.shift}`
      });
    }
    
    // 檢查最小休息時間（至少8小時）
    const restHours = calculateRestHours(newSchedule, existing);
    if (restHours < 8) {
      conflicts.push({
        type: 'INSUFFICIENT_REST',
        hours: restHours,
        message: '休息時間不足8小時'
      });
    }
  }
  
  return conflicts;
}
```

#### 智慧排班演算法
```javascript
function optimizeSchedule(requests, constraints) {
  // 1. 根據員工偏好分數排序
  const sortedRequests = requests.sort((a, b) => 
    b.preferenceScore - a.preferenceScore
  );
  
  // 2. 應用約束條件
  const schedule = [];
  for (const request of sortedRequests) {
    if (meetsConstraints(request, schedule, constraints)) {
      schedule.push(request);
    }
  }
  
  // 3. 填補空缺
  fillGaps(schedule, constraints);
  
  // 4. 平衡工作量
  balanceWorkload(schedule);
  
  return schedule;
}
```

---

## 🗳️ 6. 升遷投票系統

### 6.1 民主升遷機制

#### 功能描述
透過員工投票決定升遷，確保公平透明的晉升機會。

#### 投票流程
```
發起升遷申請 → 資格審核 → 開啟投票 → 匿名投票 → 結果公布 → 執行升遷
```

#### API 端點
```http
POST /api/promotion/initiate
GET /api/promotion/active
POST /api/promotion/vote
GET /api/promotion/results
```

#### 投票資格驗證
```javascript
function validateVotingEligibility(employee, targetPosition) {
  const eligibility = {
    qualified: true,
    reasons: []
  };
  
  // 年資要求
  const requiredYears = getPositionRequirement(targetPosition, 'years');
  if (employee.yearsOfService < requiredYears) {
    eligibility.qualified = false;
    eligibility.reasons.push(`年資不足：需要${requiredYears}年`);
  }
  
  // 績效要求
  const requiredPerformance = getPositionRequirement(targetPosition, 'performance');
  if (employee.performanceScore < requiredPerformance) {
    eligibility.qualified = false;
    eligibility.reasons.push(`績效不足：需要${requiredPerformance}分`);
  }
  
  // 投票冷卻期（上次升遷後6個月）
  const lastPromotion = getLastPromotion(employee.id);
  if (lastPromotion && daysSince(lastPromotion) < 180) {
    eligibility.qualified = false;
    eligibility.reasons.push('需等待6個月冷卻期');
  }
  
  return eligibility;
}
```

#### 匿名投票機制
```javascript
function castAnonymousVote(voterId, promotionId, decision) {
  // 生成匿名投票ID
  const anonymousId = generateAnonymousId(voterId, promotionId);
  
  // 驗證未重複投票
  if (hasVoted(anonymousId, promotionId)) {
    throw new Error('已經投過票');
  }
  
  // 記錄投票（不儲存voterId）
  const vote = {
    id: generateId(),
    promotionId: promotionId,
    anonymousId: anonymousId,
    decision: decision, // 'approve' or 'reject'
    timestamp: new Date(),
    ipHash: hashIP(getClientIP())
  };
  
  saveVote(vote);
  updateVoteCount(promotionId, decision);
}
```

---

## 🔧 7. 維修管理系統

### 7.1 設備報修功能

#### 功能描述
快速報修設備問題，追蹤維修進度，管理維修成本。

#### API 端點
```http
POST /api/maintenance/report
GET /api/maintenance/list
PUT /api/maintenance/{id}/update
```

#### 報修單格式
```json
{
  "reportDate": "2025-01-10",
  "storeName": "內壢店",
  "equipment": "冷凍庫",
  "issue": "溫度異常上升",
  "priority": "high",
  "description": "冷凍庫溫度從-18°C上升到-10°C",
  "photos": ["base64_photo1", "base64_photo2"],
  "reportedBy": 1
}
```

#### 優先級判定邏輯
```javascript
function determinePriority(equipment, issue) {
  const criticalEquipment = ['冷凍庫', '冷藏庫', '瓦斯爐', 'POS機'];
  const urgentKeywords = ['無法使用', '完全故障', '漏水', '漏電', '異味'];
  
  // 關鍵設備自動設為高優先
  if (criticalEquipment.includes(equipment)) {
    return 'high';
  }
  
  // 包含緊急關鍵字設為高優先
  for (const keyword of urgentKeywords) {
    if (issue.includes(keyword)) {
      return 'high';
    }
  }
  
  // 其他情況根據描述長度判斷
  return issue.length > 50 ? 'medium' : 'low';
}
```

#### 維修進度追蹤
```javascript
const maintenanceStates = {
  REPORTED: '已報修',
  ASSIGNED: '已指派',
  IN_PROGRESS: '維修中',
  COMPLETED: '已完成',
  VERIFIED: '已驗收'
};

function updateMaintenanceStatus(maintenanceId, newStatus, updatedBy) {
  const maintenance = getMaintenanceById(maintenanceId);
  
  // 驗證狀態轉換合法性
  if (!isValidTransition(maintenance.status, newStatus)) {
    throw new Error('無效的狀態轉換');
  }
  
  // 更新狀態
  maintenance.status = newStatus;
  maintenance.lastUpdated = new Date();
  maintenance.updatedBy = updatedBy;
  
  // 特殊處理
  if (newStatus === 'COMPLETED') {
    maintenance.completedAt = new Date();
    calculateMaintenanceCost(maintenance);
  }
  
  // 發送通知
  notifyMaintenanceUpdate(maintenance);
  
  return maintenance;
}
```

---

## 📢 8. 通知系統

### 8.1 Telegram 整合

#### 功能描述
即時推送重要通知到指定Telegram群組，支援分級通知。

#### 通知類型
```javascript
const notificationTypes = {
  CLOCK_IN: '打卡通知',
  REVENUE: '營收通知',
  ORDER: '叫貨通知',
  MAINTENANCE: '維修通知',
  PROMOTION: '升遷通知',
  ALERT: '異常警報',
  SYSTEM: '系統通知'
};
```

#### 通知格式化
```javascript
function formatTelegramMessage(type, data) {
  const templates = {
    CLOCK_IN: (d) => `
🔔 ${d.type}打卡通知

👤 員工：${d.employeeName}
📍 地點：${d.storeName}
⏰ 時間：${d.time}
📏 距離：${d.distance}公尺
${d.isLate ? `⚠️ 遲到：${d.lateMinutes}分鐘` : '✅ 準時'}
    `,
    
    REVENUE: (d) => `
💰 營收通知 - ${d.date}

🏪 分店：${d.storeName}
💵 總收入：NT$ ${d.totalRevenue.toLocaleString()}
💸 總支出：NT$ ${d.totalExpense.toLocaleString()}
💎 淨收入：NT$ ${d.netRevenue.toLocaleString()}
📊 達成率：${d.achievementRate}%
🎁 獎金：NT$ ${d.bonus.toLocaleString()}
    `,
    
    ALERT: (d) => `
🚨 異常警報！

類型：${d.alertType}
說明：${d.description}
時間：${d.timestamp}
建議：${d.suggestion}
    `
  };
  
  return templates[type](data);
}
```

#### 分級通知邏輯
```javascript
function sendNotification(type, data, priority = 'normal') {
  const channels = {
    high: [BOSS_GROUP_ID, MANAGER_GROUP_ID],
    normal: [MANAGER_GROUP_ID],
    low: [EMPLOYEE_GROUP_ID]
  };
  
  const targetChannels = channels[priority] || channels.normal;
  const message = formatTelegramMessage(type, data);
  
  for (const channelId of targetChannels) {
    sendToTelegram(channelId, message);
  }
}
```

---

## 🔒 9. 安全機制

### 9.1 身份驗證

#### JWT Token 結構
```javascript
{
  "header": {
    "alg": "HS256",
    "typ": "JWT"
  },
  "payload": {
    "userId": 1,
    "username": "john.doe",
    "role": "employee",
    "iat": 1704873600,
    "exp": 1705478400
  }
}
```

### 9.2 權限控制

#### 角色權限矩陣
| 功能 | 員工 | 主管 | 管理員 |
|------|------|------|--------|
| 打卡 | ✅ | ✅ | ✅ |
| 查看個人資料 | ✅ | ✅ | ✅ |
| 查看他人資料 | ❌ | ✅ | ✅ |
| 營收記錄 | ✅ | ✅ | ✅ |
| 查看營收報表 | ❌ | ✅ | ✅ |
| 叫貨申請 | ✅ | ✅ | ✅ |
| 審核叫貨 | ❌ | ✅ | ✅ |
| 排班申請 | ✅ | ✅ | ✅ |
| 分配排班 | ❌ | ❌ | ✅ |
| 發起升遷 | ✅ | ✅ | ✅ |
| 系統設定 | ❌ | ❌ | ✅ |

### 9.3 資料加密

#### 敏感資料處理
```javascript
// 密碼加密
const bcrypt = require('bcryptjs');
const saltRounds = 10;

async function hashPassword(password) {
  return await bcrypt.hash(password, saltRounds);
}

// 身分證號遮罩
function maskIdNumber(idNumber) {
  return idNumber.substring(0, 3) + '****' + idNumber.substring(7);
}

// API回應過濾
function filterSensitiveData(data) {
  const filtered = { ...data };
  delete filtered.password;
  delete filtered.idNumber;
  return filtered;
}
```

---

## 📊 10. 資料分析功能

### 10.1 營運儀表板

#### 關鍵指標（KPI）
```javascript
const kpiMetrics = {
  // 營收指標
  dailyRevenue: '日營收',
  monthlyRevenue: '月營收',
  revenueGrowth: '營收成長率',
  averageTransaction: '平均交易額',
  
  // 人力指標
  attendanceRate: '出勤率',
  lateRate: '遲到率',
  overtimeHours: '加班時數',
  employeeTurnover: '離職率',
  
  // 營運指標
  inventoryTurnover: '庫存週轉率',
  maintenanceCost: '維修成本',
  customerSatisfaction: '顧客滿意度'
};
```

### 10.2 報表生成

#### 月度營運報表
```javascript
function generateMonthlyReport(year, month) {
  const report = {
    period: `${year}年${month}月`,
    revenue: calculateMonthlyRevenue(year, month),
    expenses: calculateMonthlyExpenses(year, month),
    profit: calculateProfit(year, month),
    attendance: generateAttendanceReport(year, month),
    inventory: generateInventoryReport(year, month),
    maintenance: generateMaintenanceReport(year, month),
    trends: analyzeTrends(year, month),
    recommendations: generateRecommendations()
  };
  
  return report;
}
```

---

## 🎯 總結

本功能規格說明書涵蓋了企業員工管理系統的所有核心功能模組，每個功能都包含：
- 明確的業務邏輯
- 標準的API設計
- 完整的錯誤處理
- 詳細的實現代碼

這份文檔可作為開發團隊的實施指南，確保系統功能的完整性和一致性。

---

**文檔版本**: v1.0  
**更新日期**: 2025-01-10  
**編撰團隊**: AI開發小組