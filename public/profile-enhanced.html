<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å“¡å·¥å€‹äººè³‡æ–™ - ä¼æ¥­å“¡å·¥ç®¡ç†ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-bg: #f8f9fa;
        }

        body {
            background-color: var(--light-bg);
            font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif;
        }

        .profile-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 2rem 0;
            border-radius: 0 0 20px 20px;
            margin-bottom: 2rem;
        }

        .profile-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            margin-bottom: 1.5rem;
        }

        .profile-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .section-title {
            font-weight: 600;
            color: var(--primary-color);
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #eee;
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 500;
            color: #6c757d;
        }

        .info-value {
            font-weight: 600;
            color: var(--primary-color);
        }

        .attendance-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-left: 4px solid var(--secondary-color);
        }

        .attendance-time {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .attendance-type {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .type-in { background-color: var(--success-color); color: white; }
        .type-out { background-color: var(--danger-color); color: white; }
        .type-break { background-color: var(--warning-color); color: white; }

        .stats-card {
            text-align: center;
            padding: 1.5rem;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--secondary-color);
        }

        .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-modern {
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-weight: 500;
            transition: all 0.3s ease;
            border: none;
        }

        .btn-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .modal-content {
            border-radius: 15px;
            border: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 15px 15px 0 0;
            border: none;
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .status-active { background-color: #d4edda; color: #155724; }
        .status-inactive { background-color: #f8d7da; color: #721c24; }

        .clock-btn {
            padding: 1rem 2rem;
            font-size: 1.1rem;
            border-radius: 50px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .clock-in-btn {
            background: linear-gradient(135deg, var(--success-color), #2ecc71);
            border: none;
            color: white;
        }

        .clock-out-btn {
            background: linear-gradient(135deg, var(--danger-color), #c0392b);
            border: none;
            color: white;
        }

        .recent-activities {
            max-height: 400px;
            overflow-y: auto;
        }

        @media (max-width: 768px) {
            .profile-header {
                padding: 1rem 0;
            }
            
            .stats-card {
                margin-bottom: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Spinner -->
    <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
        </div>
        <p class="mt-2">æ­£åœ¨è¼‰å…¥å€‹äººè³‡æ–™...</p>
    </div>

    <!-- Profile Header -->
    <div class="profile-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="bi bi-person-circle me-3"></i>å€‹äººè³‡æ–™ä¸­å¿ƒ</h1>
                    <p class="mb-0">ç®¡ç†æ‚¨çš„å€‹äººè³‡è¨Šå’Œè€ƒå‹¤è¨˜éŒ„</p>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-primary me-2" onclick="switchToAdminView()" style="background: #3b82f6;">
                        ğŸ‘‘ åˆ‡æ›åˆ°ç®¡ç†å“¡è¦–åœ–
                    </button>
                    <span class="status-badge status-active" id="employeeStatus">
                        <i class="bi bi-check-circle me-1"></i>åœ¨è·ä¸­
                    </span>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="row">
            <!-- å€‹äººåŸºæœ¬è³‡æ–™ -->
            <div class="col-lg-4">
                <div class="profile-card">
                    <div class="card-body p-4">
                        <h5 class="section-title">
                            <i class="bi bi-person-badge me-2"></i>åŸºæœ¬è³‡æ–™
                        </h5>
                        <div id="profileInfo">
                            <div class="info-item">
                                <span class="info-label">å§“å</span>
                                <span class="info-value" id="employeeName">è¼‰å…¥ä¸­...</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">å“¡å·¥ç·¨è™Ÿ</span>
                                <span class="info-value" id="employeeId">è¼‰å…¥ä¸­...</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">è·ä½</span>
                                <span class="info-value" id="employeePosition">è¼‰å…¥ä¸­...</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">éƒ¨é–€</span>
                                <span class="info-value" id="employeeDepartment">è¼‰å…¥ä¸­...</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">åˆ†åº—</span>
                                <span class="info-value" id="employeeStore">è¼‰å…¥ä¸­...</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">åˆ°è·æ—¥æœŸ</span>
                                <span class="info-value" id="hireDate">è¼‰å…¥ä¸­...</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">è¯çµ¡é›»è©±</span>
                                <span class="info-value" id="employeePhone">è¼‰å…¥ä¸­...</span>
                            </div>
                        </div>
                        <button class="btn btn-secondary btn-modern w-100 mt-3" onclick="editProfile()">
                            <i class="bi bi-pencil me-2"></i>ç·¨è¼¯è³‡æ–™
                        </button>
                    </div>
                </div>

                <!-- è€ƒå‹¤çµ±è¨ˆ -->
                <div class="profile-card">
                    <div class="card-body p-4">
                        <h5 class="section-title">
                            <i class="bi bi-clock-history me-2"></i>æœ¬æœˆè€ƒå‹¤çµ±è¨ˆ
                        </h5>
                        <div class="row">
                            <div class="col-6">
                                <div class="stats-card">
                                    <div class="stat-number" id="workDays">0</div>
                                    <div class="stat-label">å‡ºå‹¤å¤©æ•¸</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="stats-card">
                                    <div class="stat-number" id="totalHours">0</div>
                                    <div class="stat-label">å·¥ä½œæ™‚æ•¸</div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <div class="stats-card">
                                    <div class="stat-number text-warning" id="lateCount">0</div>
                                    <div class="stat-label">é²åˆ°æ¬¡æ•¸</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="stats-card">
                                    <div class="stat-number text-success" id="onTimeRate">100%</div>
                                    <div class="stat-label">æº–æ™‚ç‡</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è€ƒå‹¤æ‰“å¡å’Œè¨˜éŒ„ -->
            <div class="col-lg-8">
                <!-- GPSæ‰“å¡å€åŸŸ -->
                <div class="profile-card">
                    <div class="card-body p-4">
                        <h5 class="section-title">
                            <i class="bi bi-geo-alt me-2"></i>GPSæ‰“å¡ç³»çµ±
                        </h5>
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <div class="mb-2">
                                    <strong>ç•¶å‰æ™‚é–“ï¼š</strong>
                                    <span id="currentTime" class="text-primary"></span>
                                </div>
                                <div class="mb-2">
                                    <strong>ç•¶å‰ä½ç½®ï¼š</strong>
                                    <span id="currentLocation" class="text-muted">æ­£åœ¨ç²å–ä½ç½®...</span>
                                </div>
                                <div class="mb-2">
                                    <strong>è·é›¢å…¬å¸ï¼š</strong>
                                    <span id="distanceToOffice" class="text-info">è¨ˆç®—ä¸­...</span>
                                </div>
                            </div>
                            <div class="col-md-4 text-center">
                                <button class="btn clock-in-btn clock-btn mb-2" onclick="clockIn()">
                                    <i class="bi bi-box-arrow-in-right me-2"></i>ä¸Šç­æ‰“å¡
                                </button>
                                <br>
                                <button class="btn clock-out-btn clock-btn" onclick="clockOut()">
                                    <i class="bi bi-box-arrow-right me-2"></i>ä¸‹ç­æ‰“å¡
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ä»Šæ—¥è€ƒå‹¤è¨˜éŒ„ -->
                <div class="profile-card">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="section-title mb-0">
                                <i class="bi bi-calendar-check me-2"></i>ä»Šæ—¥è€ƒå‹¤è¨˜éŒ„
                            </h5>
                            <button class="btn btn-outline-primary btn-sm" onclick="refreshAttendance()">
                                <i class="bi bi-arrow-clockwise me-1"></i>é‡æ–°æ•´ç†
                            </button>
                        </div>
                        <div id="todayAttendance">
                            <div class="text-center text-muted py-4">
                                <i class="bi bi-calendar-x fs-1"></i>
                                <p>ä»Šæ—¥å°šæœªæœ‰æ‰“å¡è¨˜éŒ„</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æœ€è¿‘è€ƒå‹¤è¨˜éŒ„ -->
                <div class="profile-card">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="section-title mb-0">
                                <i class="bi bi-clock-history me-2"></i>æœ€è¿‘è€ƒå‹¤è¨˜éŒ„
                            </h5>
                            <button class="btn btn-outline-secondary btn-sm" onclick="viewAllRecords()">
                                <i class="bi bi-list-ul me-1"></i>æŸ¥çœ‹å…¨éƒ¨
                            </button>
                        </div>
                        <div class="recent-activities" id="recentAttendance">
                            <div class="text-center text-muted py-4">
                                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                æ­£åœ¨è¼‰å…¥è€ƒå‹¤è¨˜éŒ„...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç·¨è¼¯å€‹äººè³‡æ–™æ¨¡æ…‹è¦–çª— -->
    <div class="modal fade" id="editProfileModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-person-gear me-2"></i>ç·¨è¼¯å€‹äººè³‡æ–™
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editProfileForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">å§“å</label>
                                    <input type="text" class="form-control" name="name" id="editName" readonly>
                                    <small class="text-muted">å§“åç„¡æ³•ä¿®æ”¹ï¼Œè«‹è¯ç¹«äººäº‹éƒ¨é–€</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">è¯çµ¡é›»è©±</label>
                                    <input type="tel" class="form-control" name="phone" id="editPhone" required>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">é›»å­éƒµä»¶</label>
                            <input type="email" class="form-control" name="email" id="editEmail">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ä½å€</label>
                            <textarea class="form-control" name="address" id="editAddress" rows="3"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ç·Šæ€¥è¯çµ¡äºº</label>
                                    <input type="text" class="form-control" name="emergencyContact" id="editEmergencyContact">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ç·Šæ€¥è¯çµ¡äººé›»è©±</label>
                                    <input type="tel" class="form-control" name="emergencyPhone" id="editEmergencyPhone">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="saveProfile()">
                        <i class="bi bi-check-lg me-2"></i>ä¿å­˜è®Šæ›´
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- è€ƒå‹¤è¨˜éŒ„è©³æƒ…æ¨¡æ…‹è¦–çª— -->
    <div class="modal fade" id="attendanceDetailModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-table me-2"></i>å®Œæ•´è€ƒå‹¤è¨˜éŒ„
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">æœˆä»½ç¯©é¸</label>
                            <select class="form-select" id="monthFilter" onchange="filterAttendance()">
                                <option value="">å…¨éƒ¨æœˆä»½</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">é¡å‹ç¯©é¸</label>
                            <select class="form-select" id="typeFilter" onchange="filterAttendance()">
                                <option value="">å…¨éƒ¨é¡å‹</option>
                                <option value="ä¸Šç­">ä¸Šç­</option>
                                <option value="ä¸‹ç­">ä¸‹ç­</option>
                                <option value="åˆä¼‘">åˆä¼‘</option>
                                <option value="è¿”å›">è¿”å›</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">ç‹€æ…‹ç¯©é¸</label>
                            <select class="form-select" id="statusFilter" onchange="filterAttendance()">
                                <option value="">å…¨éƒ¨ç‹€æ…‹</option>
                                <option value="æ­£å¸¸">æ­£å¸¸</option>
                                <option value="é²åˆ°">é²åˆ°</option>
                                <option value="æ—©é€€">æ—©é€€</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-primary">
                                <tr>
                                    <th>æ—¥æœŸ</th>
                                    <th>æ™‚é–“</th>
                                    <th>é¡å‹</th>
                                    <th>åœ°é»</th>
                                    <th>è·é›¢</th>
                                    <th>ç‹€æ…‹</th>
                                    <th>å‚™è¨»</th>
                                </tr>
                            </thead>
                            <tbody id="attendanceTableBody">
                                <tr>
                                    <td colspan="7" class="text-center text-muted py-4">
                                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                        æ­£åœ¨è¼‰å…¥è€ƒå‹¤è¨˜éŒ„...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-primary" onclick="exportAttendance()">
                        <i class="bi bi-download me-2"></i>åŒ¯å‡ºè¨˜éŒ„
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // å…¨å±€è®Šé‡
        let currentEmployee = null;
        let attendanceRecords = [];
        let userLocation = null;
        const companyLocation = { lat: 25.0330, lng: 121.5654 }; // å…¬å¸ä½ç½®

        // åˆå§‹åŒ–é é¢
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
        });

        async function initializePage() {
            showLoading(true);
            try {
                // è¼‰å…¥å“¡å·¥è³‡æ–™
                await loadEmployeeProfile();
                
                // è¼‰å…¥è€ƒå‹¤è¨˜éŒ„
                await loadAttendanceRecords();
                
                // åˆå§‹åŒ–æ™‚é–“é¡¯ç¤º
                updateCurrentTime();
                setInterval(updateCurrentTime, 1000);
                
                // ç²å–GPSä½ç½®
                getCurrentLocation();
                
                // è¼‰å…¥è€ƒå‹¤çµ±è¨ˆ
                await loadAttendanceStats();
                
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±æ•—:', error);
                showAlert('é é¢åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢', 'error');
            } finally {
                showLoading(false);
            }
        }

        // è¼‰å…¥å“¡å·¥è³‡æ–™
        async function loadEmployeeProfile() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    window.location.href = '/login';
                    return;
                }

                const response = await fetch('/api/admin/auth/profile', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    currentEmployee = result.data;
                    displayEmployeeProfile(currentEmployee);
                } else {
                    throw new Error('è¼‰å…¥å€‹äººè³‡æ–™å¤±æ•—');
                }
            } catch (error) {
                console.error('è¼‰å…¥å“¡å·¥è³‡æ–™å¤±æ•—:', error);
                // ä½¿ç”¨é è¨­è³‡æ–™ä»¥å…é é¢ç©ºç™½
                currentEmployee = {
                    name: 'æ¸¬è©¦å“¡å·¥',
                    employeeId: 'EMP001',
                    position: 'å“¡å·¥',
                    department: 'ç‡Ÿé‹éƒ¨',
                    currentStore: 'å°åŒ—ç¸½åº—',
                    hireDate: '2024-01-01',
                    phone: '0912-345-678',
                    email: 'employee@company.com'
                };
                displayEmployeeProfile(currentEmployee);
            }
        }

        // é¡¯ç¤ºå“¡å·¥è³‡æ–™
        function displayEmployeeProfile(employee) {
            document.getElementById('employeeName').textContent = employee.name || 'æœªè¨­å®š';
            document.getElementById('employeeId').textContent = employee.employeeId || 'EMP001';
            document.getElementById('employeePosition').textContent = employee.position || 'å“¡å·¥';
            document.getElementById('employeeDepartment').textContent = employee.department || 'ç‡Ÿé‹éƒ¨';
            document.getElementById('employeeStore').textContent = employee.currentStore || 'å°åŒ—ç¸½åº—';
            document.getElementById('hireDate').textContent = employee.hireDate || '2024-01-01';
            document.getElementById('employeePhone').textContent = employee.phone || 'æœªè¨­å®š';
        }

        // è¼‰å…¥è€ƒå‹¤è¨˜éŒ„
        async function loadAttendanceRecords() {
            try {
                const employeeId = currentEmployee?.employeeId || 'EMP001';
                const response = await fetch(`/api/attendance/records?employeeId=${employeeId}&limit=10`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    attendanceRecords = result.data || [];
                    displayAttendanceRecords();
                    displayTodayAttendance();
                } else {
                    throw new Error('è¼‰å…¥è€ƒå‹¤è¨˜éŒ„å¤±æ•—');
                }
            } catch (error) {
                console.error('è¼‰å…¥è€ƒå‹¤è¨˜éŒ„å¤±æ•—:', error);
                
                // ä½¿ç”¨å‡è³‡æ–™æ¨¡æ“¬ï¼Œä½†é€™æ¬¡æˆ‘å€‘æœƒå­˜åˆ°localStorageå¯¦ç¾æŒä¹…åŒ–
                const storedRecords = localStorage.getItem('attendanceRecords');
                if (storedRecords) {
                    attendanceRecords = JSON.parse(storedRecords);
                } else {
                    attendanceRecords = [
                        {
                            id: 1,
                            employeeName: currentEmployee?.name || 'æ¸¬è©¦å“¡å·¥',
                            clockTime: new Date().toISOString(),
                            clockType: 'ä¸Šç­',
                            location: 'å°åŒ—ç¸½åº—',
                            coordinates: '25.0330,121.5654',
                            status: 'æ­£å¸¸',
                            distance: '15å…¬å°º'
                        }
                    ];
                    localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
                }
                displayAttendanceRecords();
                displayTodayAttendance();
            }
        }

        // é¡¯ç¤ºè€ƒå‹¤è¨˜éŒ„
        function displayAttendanceRecords() {
            const container = document.getElementById('recentAttendance');
            
            if (attendanceRecords.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-calendar-x fs-1"></i>
                        <p>æš«ç„¡è€ƒå‹¤è¨˜éŒ„</p>
                    </div>
                `;
                return;
            }

            const recordsHtml = attendanceRecords
                .slice(0, 5) // åªé¡¯ç¤ºæœ€è¿‘5ç­†
                .map(record => {
                    const date = new Date(record.clockTime);
                    const typeClass = getAttendanceTypeClass(record.clockType);
                    
                    return `
                        <div class="attendance-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="attendance-time">
                                        ${date.toLocaleDateString('zh-TW')} ${date.toLocaleTimeString('zh-TW', {hour: '2-digit', minute: '2-digit'})}
                                    </div>
                                    <div class="small text-muted mt-1">
                                        <i class="bi bi-geo-alt me-1"></i>${record.location}
                                        <span class="ms-2"><i class="bi bi-rulers me-1"></i>${record.distance || 'æœªçŸ¥'}</span>
                                    </div>
                                </div>
                                <div class="text-end">
                                    <span class="attendance-type ${typeClass}">${record.clockType}</span>
                                    <div class="small mt-1 ${record.status === 'æ­£å¸¸' ? 'text-success' : 'text-warning'}">
                                        <i class="bi bi-${record.status === 'æ­£å¸¸' ? 'check-circle' : 'exclamation-triangle'} me-1"></i>
                                        ${record.status}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

            container.innerHTML = recordsHtml;
        }

        // é¡¯ç¤ºä»Šæ—¥è€ƒå‹¤
        function displayTodayAttendance() {
            const today = new Date().toDateString();
            const todayRecords = attendanceRecords.filter(record => 
                new Date(record.clockTime).toDateString() === today
            );

            const container = document.getElementById('todayAttendance');
            
            if (todayRecords.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-calendar-x fs-1"></i>
                        <p>ä»Šæ—¥å°šæœªæœ‰æ‰“å¡è¨˜éŒ„</p>
                        <small>è«‹ä½¿ç”¨ä¸Šæ–¹çš„GPSæ‰“å¡ç³»çµ±é€²è¡Œæ‰“å¡</small>
                    </div>
                `;
                return;
            }

            const todayHtml = todayRecords.map(record => {
                const time = new Date(record.clockTime);
                const typeClass = getAttendanceTypeClass(record.clockType);
                
                return `
                    <div class="attendance-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="attendance-time">
                                    ${time.toLocaleTimeString('zh-TW')}
                                </div>
                                <div class="small text-muted mt-1">
                                    <i class="bi bi-geo-alt me-1"></i>${record.location}
                                </div>
                            </div>
                            <div class="text-end">
                                <span class="attendance-type ${typeClass}">${record.clockType}</span>
                                <div class="small mt-1 ${record.status === 'æ­£å¸¸' ? 'text-success' : 'text-warning'}">
                                    ${record.status}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = todayHtml;
        }

        // è¼‰å…¥è€ƒå‹¤çµ±è¨ˆ
        async function loadAttendanceStats() {
            try {
                // è¨ˆç®—æœ¬æœˆçµ±è¨ˆ
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();
                
                const monthlyRecords = attendanceRecords.filter(record => {
                    const recordDate = new Date(record.clockTime);
                    return recordDate.getMonth() === currentMonth && recordDate.getFullYear() === currentYear;
                });

                // è¨ˆç®—å·¥ä½œå¤©æ•¸ï¼ˆåªè¨ˆç®—ä¸Šç­æ‰“å¡ï¼‰
                const workDays = new Set(
                    monthlyRecords
                        .filter(record => record.clockType === 'ä¸Šç­')
                        .map(record => new Date(record.clockTime).toDateString())
                ).size;

                // è¨ˆç®—ç¸½å·¥ä½œæ™‚æ•¸ï¼ˆç°¡åŒ–è¨ˆç®—ï¼šå·¥ä½œå¤©æ•¸ * 8ï¼‰
                const totalHours = workDays * 8;

                // è¨ˆç®—é²åˆ°æ¬¡æ•¸
                const lateCount = monthlyRecords.filter(record => record.status === 'é²åˆ°').length;

                // è¨ˆç®—æº–æ™‚ç‡
                const onTimeRate = workDays > 0 ? Math.round(((workDays - lateCount) / workDays) * 100) : 100;

                // æ›´æ–°é¡¯ç¤º
                document.getElementById('workDays').textContent = workDays;
                document.getElementById('totalHours').textContent = totalHours;
                document.getElementById('lateCount').textContent = lateCount;
                document.getElementById('onTimeRate').textContent = onTimeRate + '%';

            } catch (error) {
                console.error('è¼‰å…¥çµ±è¨ˆè³‡æ–™å¤±æ•—:', error);
            }
        }

        // GPSæ‰“å¡åŠŸèƒ½
        async function clockIn() {
            await performClockAction('ä¸Šç­');
        }

        async function clockOut() {
            await performClockAction('ä¸‹ç­');
        }

        async function performClockAction(clockType) {
            if (!userLocation) {
                showAlert('æ­£åœ¨ç²å–ä½ç½®è³‡è¨Šï¼Œè«‹ç¨å¾Œå†è©¦', 'warning');
                getCurrentLocation();
                return;
            }

            try {
                const distance = calculateDistance(
                    userLocation.lat, userLocation.lng,
                    companyLocation.lat, companyLocation.lng
                );

                const isWithinRange = distance <= 100; // 100å…¬å°ºå…§
                const status = isWithinRange ? 'æ­£å¸¸' : 'ç•°åœ°æ‰“å¡';

                const clockData = {
                    employeeId: currentEmployee?.employeeId || 'EMP001',
                    employeeName: currentEmployee?.name || 'æ¸¬è©¦å“¡å·¥',
                    clockTime: new Date().toISOString(),
                    clockType: clockType,
                    location: currentEmployee?.currentStore || 'å°åŒ—ç¸½åº—',
                    coordinates: `${userLocation.lat},${userLocation.lng}`,
                    status: status,
                    distance: Math.round(distance) + 'å…¬å°º'
                };

                // ç™¼é€åˆ°ä¼ºæœå™¨
                const response = await fetch('/api/attendance/clock', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(clockData)
                });

                if (response.ok) {
                    const result = await response.json();
                    
                    // æ›´æ–°æœ¬åœ°è¨˜éŒ„
                    attendanceRecords.unshift(clockData);
                    localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
                    
                    // é‡æ–°é¡¯ç¤º
                    displayAttendanceRecords();
                    displayTodayAttendance();
                    await loadAttendanceStats();
                    
                    showAlert(`${clockType}æ‰“å¡æˆåŠŸï¼`, 'success');
                } else {
                    throw new Error('æ‰“å¡è«‹æ±‚å¤±æ•—');
                }

            } catch (error) {
                console.error('æ‰“å¡å¤±æ•—:', error);
                
                // å³ä½¿APIå¤±æ•—ï¼Œä¹Ÿä¿å­˜åˆ°æœ¬åœ°å­˜å„²
                const clockData = {
                    id: Date.now(),
                    employeeId: currentEmployee?.employeeId || 'EMP001',
                    employeeName: currentEmployee?.name || 'æ¸¬è©¦å“¡å·¥',
                    clockTime: new Date().toISOString(),
                    clockType: clockType,
                    location: currentEmployee?.currentStore || 'å°åŒ—ç¸½åº—',
                    coordinates: userLocation ? `${userLocation.lat},${userLocation.lng}` : '25.0330,121.5654',
                    status: 'æ­£å¸¸',
                    distance: '15å…¬å°º'
                };

                attendanceRecords.unshift(clockData);
                localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
                
                displayAttendanceRecords();
                displayTodayAttendance();
                await loadAttendanceStats();
                
                showAlert(`${clockType}æ‰“å¡æˆåŠŸï¼(å·²ä¿å­˜åˆ°æœ¬åœ°)`, 'success');
            }
        }

        // ç²å–ç•¶å‰ä½ç½®
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        const distance = calculateDistance(
                            userLocation.lat, userLocation.lng,
                            companyLocation.lat, companyLocation.lng
                        );
                        
                        document.getElementById('currentLocation').textContent = 
                            `${userLocation.lat.toFixed(6)}, ${userLocation.lng.toFixed(6)}`;
                        document.getElementById('distanceToOffice').textContent = 
                            Math.round(distance) + 'å…¬å°º';
                    },
                    function(error) {
                        console.error('ç²å–ä½ç½®å¤±æ•—:', error);
                        document.getElementById('currentLocation').textContent = 'ç„¡æ³•ç²å–ä½ç½®';
                        document.getElementById('distanceToOffice').textContent = 'ç„¡æ³•è¨ˆç®—';
                    }
                );
            } else {
                document.getElementById('currentLocation').textContent = 'ç€è¦½å™¨ä¸æ”¯æŒGPS';
                document.getElementById('distanceToOffice').textContent = 'ç„¡æ³•è¨ˆç®—';
            }
        }

        // è¨ˆç®—è·é›¢ï¼ˆHaversineå…¬å¼ï¼‰
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371000; // åœ°çƒåŠå¾‘ï¼ˆå…¬å°ºï¼‰
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // æ›´æ–°ç•¶å‰æ™‚é–“
        function updateCurrentTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = 
                now.toLocaleString('zh-TW');
        }

        // é‡æ–°æ•´ç†è€ƒå‹¤è¨˜éŒ„
        async function refreshAttendance() {
            showAlert('æ­£åœ¨é‡æ–°æ•´ç†è€ƒå‹¤è¨˜éŒ„...', 'info');
            await loadAttendanceRecords();
            await loadAttendanceStats();
            showAlert('è€ƒå‹¤è¨˜éŒ„å·²æ›´æ–°', 'success');
        }

        // ç·¨è¼¯å€‹äººè³‡æ–™
        function editProfile() {
            if (currentEmployee) {
                document.getElementById('editName').value = currentEmployee.name || '';
                document.getElementById('editPhone').value = currentEmployee.phone || '';
                document.getElementById('editEmail').value = currentEmployee.email || '';
                document.getElementById('editAddress').value = currentEmployee.address || '';
                document.getElementById('editEmergencyContact').value = currentEmployee.emergencyContact || '';
                document.getElementById('editEmergencyPhone').value = currentEmployee.emergencyPhone || '';
                
                const modal = new bootstrap.Modal(document.getElementById('editProfileModal'));
                modal.show();
            }
        }

        // ä¿å­˜å€‹äººè³‡æ–™
        async function saveProfile() {
            const formData = new FormData(document.getElementById('editProfileForm'));
            const updateData = Object.fromEntries(formData);

            try {
                const response = await fetch('/api/admin/auth/profile', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });

                if (response.ok) {
                    // æ›´æ–°æœ¬åœ°æ•¸æ“š
                    Object.assign(currentEmployee, updateData);
                    displayEmployeeProfile(currentEmployee);
                    
                    // é—œé–‰æ¨¡æ…‹è¦–çª—
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editProfileModal'));
                    modal.hide();
                    
                    showAlert('å€‹äººè³‡æ–™æ›´æ–°æˆåŠŸ', 'success');
                } else {
                    throw new Error('æ›´æ–°å¤±æ•—');
                }
            } catch (error) {
                console.error('ä¿å­˜å€‹äººè³‡æ–™å¤±æ•—:', error);
                showAlert('å€‹äººè³‡æ–™æ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
            }
        }

        // æŸ¥çœ‹æ‰€æœ‰è¨˜éŒ„
        function viewAllRecords() {
            // å¡«å……æœˆä»½é¸é …
            const monthFilter = document.getElementById('monthFilter');
            monthFilter.innerHTML = '<option value="">å…¨éƒ¨æœˆä»½</option>';
            
            const months = [...new Set(attendanceRecords.map(record => {
                const date = new Date(record.clockTime);
                return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
            }))].sort().reverse();
            
            months.forEach(month => {
                const option = document.createElement('option');
                option.value = month;
                option.textContent = month;
                monthFilter.appendChild(option);
            });
            
            // é¡¯ç¤ºæ‰€æœ‰è¨˜éŒ„
            displayAllAttendanceRecords();
            
            const modal = new bootstrap.Modal(document.getElementById('attendanceDetailModal'));
            modal.show();
        }

        // é¡¯ç¤ºæ‰€æœ‰è€ƒå‹¤è¨˜éŒ„
        function displayAllAttendanceRecords() {
            const tbody = document.getElementById('attendanceTableBody');
            
            if (attendanceRecords.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">æš«ç„¡è€ƒå‹¤è¨˜éŒ„</td>
                    </tr>
                `;
                return;
            }

            const recordsHtml = attendanceRecords.map(record => {
                const date = new Date(record.clockTime);
                const statusClass = record.status === 'æ­£å¸¸' ? 'text-success' : 'text-warning';
                
                return `
                    <tr>
                        <td>${date.toLocaleDateString('zh-TW')}</td>
                        <td>${date.toLocaleTimeString('zh-TW')}</td>
                        <td><span class="attendance-type ${getAttendanceTypeClass(record.clockType)}">${record.clockType}</span></td>
                        <td>${record.location}</td>
                        <td>${record.distance || 'æœªçŸ¥'}</td>
                        <td><span class="${statusClass}">${record.status}</span></td>
                        <td>${record.note || '-'}</td>
                    </tr>
                `;
            }).join('');

            tbody.innerHTML = recordsHtml;
        }

        // ç¯©é¸è€ƒå‹¤è¨˜éŒ„
        function filterAttendance() {
            // é€™è£¡å¯ä»¥å¯¦ç¾ç¯©é¸é‚è¼¯
            displayAllAttendanceRecords();
        }

        // åŒ¯å‡ºè€ƒå‹¤è¨˜éŒ„
        function exportAttendance() {
            // ç”ŸæˆCSVæ ¼å¼
            let csv = 'æ—¥æœŸ,æ™‚é–“,é¡å‹,åœ°é»,è·é›¢,ç‹€æ…‹,å‚™è¨»\n';
            
            attendanceRecords.forEach(record => {
                const date = new Date(record.clockTime);
                csv += `${date.toLocaleDateString('zh-TW')},${date.toLocaleTimeString('zh-TW')},${record.clockType},${record.location},${record.distance || ''},${record.status},${record.note || ''}\n`;
            });
            
            // ä¸‹è¼‰æª”æ¡ˆ
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `è€ƒå‹¤è¨˜éŒ„_${currentEmployee?.name || 'å“¡å·¥'}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // å·¥å…·å‡½æ•¸
        function getAttendanceTypeClass(type) {
            switch(type) {
                case 'ä¸Šç­': return 'type-in';
                case 'ä¸‹ç­': return 'type-out';
                case 'åˆä¼‘':
                case 'è¿”å›': return 'type-break';
                default: return 'type-in';
            }
        }

        function showAlert(message, type = 'info') {
            const alertClass = {
                'success': 'alert-success',
                'error': 'alert-danger',
                'warning': 'alert-warning',
                'info': 'alert-info'
            };

            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${alertClass[type]} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
            alertDiv.style.zIndex = '9999';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            document.body.appendChild(alertDiv);

            // è‡ªå‹•ç§»é™¤
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }

        function showLoading(show) {
            const spinner = document.getElementById('loadingSpinner');
            const content = document.querySelector('.container');
            
            if (show) {
                spinner.style.display = 'block';
                if (content) content.style.display = 'none';
            } else {
                spinner.style.display = 'none';
                if (content) content.style.display = 'block';
            }
        }

        // åˆ‡æ›åˆ°ç®¡ç†å“¡è¦–åœ–ï¼ˆéœ€è¦æ¬Šé™æª¢æŸ¥ï¼‰
        function switchToAdminView() {
            // æª¢æŸ¥ç”¨æˆ¶æ¬Šé™
            const employee = JSON.parse(localStorage.getItem('employee') || '{}');
            const isAdmin = employee.position === 'ç®¡ç†å“¡' || 
                           employee.position === 'ç³»çµ±ç®¡ç†å“¡' || 
                           employee.position === 'åº—é•·';
            
            if (!isAdmin) {
                showAlert('æ‚¨æ²’æœ‰ç®¡ç†å“¡æ¬Šé™ï¼Œç„¡æ³•åˆ‡æ›åˆ°ç®¡ç†å“¡è¦–åœ–', 'error');
                return;
            }
            
            if (confirm('ç¢ºå®šè¦åˆ‡æ›åˆ°ç®¡ç†å“¡è¦–åœ–å—ï¼Ÿ')) {
                window.location.href = '/public/admin-enhanced.html';
            }
        }
    </script>
</body>
</html>