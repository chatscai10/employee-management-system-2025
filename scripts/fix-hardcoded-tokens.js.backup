/**
 * æ‰¹é‡ä¿®å¾©ç¡¬ç·¨ç¢¼Tokenè…³æœ¬
 * Claude Codeå®‰å…¨ç›¸å®¹æ€§ä¿®å¾©å·¥å…·
 */

const fs = require('fs');
const path = require('path');

class TokenReplacer {
    constructor() {
        this.hardcodedToken = '7659930552:AAF_jF1rAXFnjFO176-9X5fKfBwbrko8BNc';
        this.hardcodedGroupId = '-1002658082392';
        
        this.replacements = [
            {
                search: /7659930552:AAF_jF1rAXFnjFO176-9X5fKfBwbrko8BNc/g,
                replace: 'process.env.TELEGRAM_BOT_TOKEN',
                description: 'Telegram Bot Token'
            },
            {
                search: /-1002658082392/g,
                replace: 'process.env.TELEGRAM_GROUP_ID',
                description: 'Telegram Group ID'
            }
        ];

        this.affectedFiles = [];
        this.stats = {
            scanned: 0,
            modified: 0,
            errors: 0
        };
    }

    async scanAndFix() {
        console.log('ğŸ” é–‹å§‹æƒæå’Œä¿®å¾©ç¡¬ç·¨ç¢¼Token...');
        
        // ç²å–æ‰€æœ‰å—å½±éŸ¿çš„æª”æ¡ˆ
        await this.findAffectedFiles();
        
        console.log(`ğŸ“Š æ‰¾åˆ° ${this.affectedFiles.length} å€‹å—å½±éŸ¿çš„æª”æ¡ˆ`);
        
        // æ‰¹é‡ä¿®å¾©
        for (const filePath of this.affectedFiles) {
            await this.replaceInFile(filePath);
        }

        this.generateReport();
    }

    async findAffectedFiles() {
        const { execSync } = require('child_process');
        
        try {
            // ä½¿ç”¨grepæ‰¾åˆ°æ‰€æœ‰åŒ…å«ç¡¬ç·¨ç¢¼tokençš„æª”æ¡ˆ
            const result = execSync('grep -r -l "7659930552:AAF_jF1rAXFnjFO176-9X5fKfBwbrko8BNc" . --exclude-dir=node_modules --exclude-dir=.git', 
                { encoding: 'utf8', cwd: process.cwd() });
            
            this.affectedFiles = result.trim().split('\n').filter(file => file && file.length > 0);
        } catch (error) {
            console.warn('âš ï¸ grepæƒæå¤±æ•—ï¼Œä½¿ç”¨æ‰‹å‹•æ–¹å¼');
            // å‚™ç”¨æ–¹å¼ï¼šæ‰‹å‹•æƒæéƒ¨åˆ†é‡è¦æª”æ¡ˆ
            this.affectedFiles = [
                './public/login.html',
                './server/middleware/auditLogger.js',
                './telegram-notifier.js'
            ].filter(file => fs.existsSync(file));
        }
    }

    async replaceInFile(filePath) {
        try {
            this.stats.scanned++;
            
            if (!fs.existsSync(filePath)) {
                console.warn(`âš ï¸ æª”æ¡ˆä¸å­˜åœ¨: ${filePath}`);
                return false;
            }

            let content = fs.readFileSync(filePath, 'utf8');
            let modified = false;
            let changes = [];

            this.replacements.forEach(({ search, replace, description }) => {
                const matches = content.match(search);
                if (matches) {
                    content = content.replace(search, replace);
                    modified = true;
                    changes.push(`${description}: ${matches.length} è™•`);
                }
            });

            if (modified) {
                // æª¢æŸ¥æ˜¯å¦éœ€è¦æ·»åŠ dotenvé…ç½®
                if (!content.includes("require('dotenv')") && 
                    !content.includes('process.env.TELEGRAM') &&
                    filePath.endsWith('.js')) {
                    
                    // å¦‚æœæ˜¯JSæª”æ¡ˆä¸”ä½¿ç”¨äº†ç’°å¢ƒè®Šæ•¸ï¼Œæ·»åŠ dotenv
                    if (content.includes('process.env.TELEGRAM_BOT_TOKEN')) {
                        content = "require('dotenv').config();\n" + content;
                        changes.push('æ·»åŠ  dotenv é…ç½®');
                    }
                }

                // å‚™ä»½åŸå§‹æª”æ¡ˆ
                const backupPath = `${filePath}.backup`;
                if (!fs.existsSync(backupPath)) {
                    fs.copyFileSync(filePath, backupPath);
                }

                fs.writeFileSync(filePath, content, 'utf8');
                console.log(`âœ… ä¿®å¾©: ${filePath}`);
                console.log(`   è®Šæ›´: ${changes.join(', ')}`);
                
                this.stats.modified++;
                return true;
            } else {
                console.log(`â„¹ï¸ è·³é: ${filePath} (ç„¡éœ€ä¿®å¾©)`);
                return false;
            }
        } catch (error) {
            console.error(`âŒ éŒ¯èª¤ä¿®å¾© ${filePath}:`, error.message);
            this.stats.errors++;
            return false;
        }
    }

    generateReport() {
        const report = {
            timestamp: new Date().toISOString(),
            stats: this.stats,
            summary: {
                totalFiles: this.affectedFiles.length,
                modifiedFiles: this.stats.modified,
                successRate: `${((this.stats.modified / this.stats.scanned) * 100).toFixed(1)}%`
            }
        };

        // ä¿å­˜å ±å‘Š
        fs.writeFileSync('token-fix-report.json', JSON.stringify(report, null, 2));

        console.log('\nğŸ“Š ä¿®å¾©å®Œæˆå ±å‘Š:');
        console.log(`   æƒææª”æ¡ˆ: ${this.stats.scanned}`);
        console.log(`   ä¿®å¾©æª”æ¡ˆ: ${this.stats.modified}`);
        console.log(`   éŒ¯èª¤æ•¸é‡: ${this.stats.errors}`);
        console.log(`   æˆåŠŸç‡: ${report.summary.successRate}`);
        console.log('\nğŸ‰ ç¡¬ç·¨ç¢¼Tokenä¿®å¾©å®Œæˆï¼');
        console.log('ğŸ’¡ è«‹ç¢ºèª.envæª”æ¡ˆåŒ…å«æ­£ç¢ºçš„TELEGRAM_BOT_TOKENå’ŒTELEGRAM_GROUP_ID');
    }

    async rollback() {
        console.log('ğŸ”„ é–‹å§‹å›æ»¾ä¿®å¾©...');
        let rolledBack = 0;

        for (const filePath of this.affectedFiles) {
            const backupPath = `${filePath}.backup`;
            if (fs.existsSync(backupPath)) {
                fs.copyFileSync(backupPath, filePath);
                fs.unlinkSync(backupPath);
                console.log(`â†©ï¸ å›æ»¾: ${filePath}`);
                rolledBack++;
            }
        }

        console.log(`âœ… å›æ»¾å®Œæˆ: ${rolledBack} å€‹æª”æ¡ˆ`);
    }
}

// CLIåŸ·è¡Œ
if (require.main === module) {
    const args = process.argv.slice(2);
    const replacer = new TokenReplacer();

    if (args.includes('--rollback')) {
        replacer.rollback();
    } else {
        replacer.scanAndFix();
    }
}

module.exports = TokenReplacer;