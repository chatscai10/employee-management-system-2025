# âš™ï¸ çµæœè‡ªå‹•åŸ·è¡Œç³»çµ±è©³ç´°è¦åŠƒ

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°
å¯¦ç¾æŠ•ç¥¨çµæœçš„è‡ªå‹•åŸ·è¡Œæ©Ÿåˆ¶ï¼ŒåŒ…æ‹¬è·ä½è®Šæ›´ã€è–ªè³‡èª¿æ•´ã€æ¬Šé™æ›´æ–°ç­‰å®Œæ•´çš„äººäº‹æµç¨‹è‡ªå‹•åŒ–ã€‚

## ğŸ”§ æ•¸æ“šæ¨¡å‹è¨­è¨ˆ

### PositionChangeExecution (è·ä½è®Šæ›´åŸ·è¡Œè¡¨)
```javascript
{
  id: INTEGER (ä¸»éµ),
  campaignId: INTEGER (æŠ•ç¥¨æ´»å‹•ID),
  employeeId: INTEGER (å“¡å·¥ID),
  changeType: ENUM('promotion', 'demotion', 'lateral_transfer'),
  oldPosition: STRING (åŸè·ä½),
  newPosition: STRING (æ–°è·ä½),
  oldSalaryGrade: INTEGER (åŸè–ªè³‡ç­‰ç´š),
  newSalaryGrade: INTEGER (æ–°è–ªè³‡ç­‰ç´š),
  executionStatus: ENUM('pending', 'in_progress', 'completed', 'failed', 'rolled_back'),
  scheduledExecutionTime: DATE (é å®šåŸ·è¡Œæ™‚é–“),
  actualExecutionTime: DATE (å¯¦éš›åŸ·è¡Œæ™‚é–“),
  executionSteps: JSON (åŸ·è¡Œæ­¥é©Ÿè¨˜éŒ„),
  executionResults: JSON (åŸ·è¡Œçµæœè©³æƒ…),
  rollbackData: JSON (å›æ»¾å‚™ä»½æ•¸æ“š),
  approvedBy: INTEGER (å¯©æ‰¹äººID),
  executedBy: STRING (åŸ·è¡Œè€… - é€šå¸¸æ˜¯SYSTEM),
  failureReason: TEXT (å¤±æ•—åŸå› ),
  notificationsSent: JSON (å·²ç™¼é€é€šçŸ¥è¨˜éŒ„),
  createdAt: DATE,
  updatedAt: DATE
}
```

### ExecutionAuditLog (åŸ·è¡Œå¯©è¨ˆæ—¥èªŒè¡¨)
```javascript
{
  id: INTEGER (ä¸»éµ),
  executionId: INTEGER (åŸ·è¡Œè¨˜éŒ„ID),
  step: STRING (åŸ·è¡Œæ­¥é©Ÿ),
  status: ENUM('started', 'completed', 'failed', 'skipped'),
  startTime: DATE (é–‹å§‹æ™‚é–“),
  endTime: DATE (çµæŸæ™‚é–“),
  duration: INTEGER (åŸ·è¡Œæ™‚é•·æ¯«ç§’),
  details: JSON (åŸ·è¡Œè©³æƒ…),
  errorMessage: TEXT (éŒ¯èª¤ä¿¡æ¯),
  systemState: JSON (ç³»çµ±ç‹€æ…‹å¿«ç…§),
  createdAt: DATE
}
```

## âš™ï¸ åŸ·è¡Œé‚è¼¯æµç¨‹

### ğŸ¯ è‡ªå‹•åŸ·è¡Œè§¸ç™¼æ¢ä»¶
```javascript
const EXECUTION_TRIGGERS = {
  // æŠ•ç¥¨çµæŸå¾Œè‡ªå‹•è§¸ç™¼
  automatic: {
    // è½‰æ­£æŠ•ç¥¨é€šé (50%ä»¥ä¸ŠåŒæ„)
    promotion_passed: {
      condition: 'agreePercentage >= 50.0',
      delay: '24_hours', // 24å°æ™‚å¾ŒåŸ·è¡Œ
      executionSteps: [
        'validate_result',
        'backup_current_state',
        'update_position',
        'adjust_salary',
        'update_permissions',
        'send_notifications',
        'update_system_records'
      ]
    },
    
    // æ‡²ç½°æŠ•ç¥¨é€šé (30%ä»¥ä¸ŠåŒæ„)
    demotion_passed: {
      condition: 'agreePercentage >= 30.0',
      delay: 'immediate', // ç«‹å³åŸ·è¡Œ
      executionSteps: [
        'validate_result',
        'backup_current_state',
        'downgrade_position',
        'adjust_salary',
        'restrict_permissions',
        'record_disciplinary_action',
        'send_notifications',
        'update_system_records'
      ]
    }
  },
  
  // æ‰‹å‹•è§¸ç™¼
  manual: {
    admin_override: {
      requiredRole: 'admin',
      approvalRequired: true,
      auditLogging: true
    }
  }
}
```

### ğŸ”„ åŸ·è¡Œæ­¥é©Ÿè©³ç´°é‚è¼¯
```javascript
const EXECUTION_STEPS = {
  // æ­¥é©Ÿ1: çµæœé©—è­‰
  validate_result: {
    checks: [
      'ç¢ºèªæŠ•ç¥¨å·²æ­£å¼çµæŸ',
      'é©—è­‰æŠ•ç¥¨çµæœå®Œæ•´æ€§',
      'æª¢æŸ¥æ˜¯å¦æœ‰ç”³è¨´é€²è¡Œä¸­',
      'ç¢ºèªåŸ·è¡Œæ¢ä»¶ç¬¦åˆ'
    ],
    failureAction: 'abort_execution',
    rollbackRequired: false
  },
  
  // æ­¥é©Ÿ2: å‚™ä»½ç•¶å‰ç‹€æ…‹
  backup_current_state: {
    backupData: [
      'employee.position',
      'employee.salaryGrade',
      'employee.permissions',
      'employee.positionStartDate',
      'related_system_settings'
    ],
    storageLocation: 'rollbackData',
    rollbackRequired: false
  },
  
  // æ­¥é©Ÿ3: æ›´æ–°è·ä½
  update_position: {
    transaction: true,
    operations: [
      {
        table: 'employees',
        action: 'update',
        fields: {
          position: 'newPosition',
          positionStartDate: 'executionTime',
          lastPromotionDate: 'executionTime'
        }
      }
    ],
    rollbackRequired: true
  },
  
  // æ­¥é©Ÿ4: èª¿æ•´è–ªè³‡
  adjust_salary: {
    calculation: {
      promotion: {
        formula: 'baseSalary * promotionMultiplier[newPosition]',
        minimumIncrease: 0.1, // è‡³å°‘èª¿å‡10%
        maximumIncrease: 0.3  // æœ€å¤šèª¿å‡30%
      },
      demotion: {
        formula: 'baseSalary * demotionMultiplier[newPosition]',
        minimumDecrease: 0.1, // è‡³å°‘èª¿é™10%
        maximumDecrease: 0.2  // æœ€å¤šèª¿é™20%
      }
    },
    rollbackRequired: true
  },
  
  // æ­¥é©Ÿ5: æ¬Šé™æ›´æ–°
  update_permissions: {
    systemPermissions: {
      promotion: 'grant_higher_level_access',
      demotion: 'revoke_unnecessary_access'
    },
    storeAccess: {
      managerPromotion: 'grant_store_management_access',
      managerDemotion: 'revoke_store_management_access'
    },
    rollbackRequired: true
  },
  
  // æ­¥é©Ÿ6: ç™¼é€é€šçŸ¥
  send_notifications: {
    recipients: [
      'affected_employee',
      'direct_supervisor',
      'hr_department',
      'store_manager'
    ],
    templates: {
      promotion: 'position_change_promotion',
      demotion: 'position_change_demotion'
    },
    rollbackRequired: false
  },
  
  // æ­¥é©Ÿ7: æ›´æ–°ç³»çµ±è¨˜éŒ„
  update_system_records: {
    records: [
      'position_history',
      'salary_history', 
      'permission_changes',
      'performance_records'
    ],
    rollbackRequired: true
  }
}
```

## ğŸ›¡ï¸ åŸ·è¡Œå®‰å…¨æ©Ÿåˆ¶

### ğŸ”’ åŸ·è¡Œå‰å®‰å…¨æª¢æŸ¥
```javascript
const SAFETY_CHECKS = {
  // æ¥­å‹™é‚è¼¯æª¢æŸ¥
  business_validation: {
    checks: [
      {
        name: 'minimum_tenure_check',
        rule: 'å“¡å·¥åœ¨è·è‡³å°‘90å¤©æ‰å¯åŸ·è¡Œé™è·',
        applicable: ['demotion']
      },
      {
        name: 'maximum_position_check', 
        rule: 'ä¸èƒ½æ™‰å‡è¶…éç•¶å‰è·ä½+2ç´š',
        applicable: ['promotion']
      },
      {
        name: 'store_capacity_check',
        rule: 'æª¢æŸ¥ç›®æ¨™è·ä½æ˜¯å¦æœ‰ç©ºç¼º',
        applicable: ['promotion', 'demotion']
      }
    ]
  },
  
  // ç³»çµ±ç‹€æ…‹æª¢æŸ¥
  system_validation: {
    checks: [
      'è³‡æ–™åº«é€£æ¥æ­£å¸¸',
      'ç›¸é—œç³»çµ±æœå‹™é‹è¡Œ',
      'å‚™ä»½ç³»çµ±å¯ç”¨',
      'é€šçŸ¥æœå‹™æ­£å¸¸'
    ]
  },
  
  // è¡çªæª¢æŸ¥
  conflict_detection: {
    checks: [
      'åŒä¸€å“¡å·¥æ˜¯å¦æœ‰å…¶ä»–é€²è¡Œä¸­çš„è®Šæ›´',
      'ç›¸åŒè·ä½æ˜¯å¦æœ‰åŒæ™‚åŸ·è¡Œçš„è®Šæ›´',
      'ç³»çµ±ç¶­è­·æœŸé–“ç¦æ­¢åŸ·è¡Œ'
    ]
  }
}
```

### ğŸ”„ å›æ»¾æ©Ÿåˆ¶
```javascript
const ROLLBACK_MECHANISM = {
  // è‡ªå‹•å›æ»¾è§¸ç™¼æ¢ä»¶
  auto_rollback_triggers: [
    'execution_step_failure',
    'system_error_detected',
    'data_corruption_detected',
    'external_system_failure'
  ],
  
  // å›æ»¾åŸ·è¡Œæ­¥é©Ÿ
  rollback_steps: [
    {
      step: 'restore_employee_data',
      data_source: 'rollbackData.employee',
      priority: 1
    },
    {
      step: 'restore_salary_data', 
      data_source: 'rollbackData.salary',
      priority: 2
    },
    {
      step: 'restore_permissions',
      data_source: 'rollbackData.permissions', 
      priority: 3
    },
    {
      step: 'cleanup_partial_changes',
      data_source: 'audit_log',
      priority: 4
    },
    {
      step: 'send_rollback_notifications',
      priority: 5
    }
  ],
  
  // å›æ»¾å®Œæ•´æ€§æª¢æŸ¥
  rollback_verification: [
    'å°æ¯”åŸ·è¡Œå‰å¾Œæ•¸æ“šä¸€è‡´æ€§',
    'ç¢ºèªæ‰€æœ‰ç³»çµ±ç‹€æ…‹æ¢å¾©',
    'é©—è­‰æ¬Šé™æ­£ç¢ºå›æ»¾',
    'æª¢æŸ¥é€šçŸ¥ç‹€æ…‹æ¸…ç†'
  ]
}
```

## â° åŸ·è¡Œæ™‚é–“æ§åˆ¶

### ğŸ“… åŸ·è¡Œæ™‚é–“ç­–ç•¥
```javascript
const EXECUTION_TIMING = {
  // è½‰æ­£åŸ·è¡Œ (éç·Šæ€¥)
  promotion_execution: {
    delay: '24_hours', // çµ¦ç”³è¨´æ©Ÿæœƒ
    preferred_time: {
      weekday: 'monday_to_friday',
      hour: 9, // ä¸Šåˆ9é»
      timezone: 'Asia/Taipei'
    },
    avoid_periods: [
      'company_holidays',
      'month_end_closing',
      'system_maintenance'
    ]
  },
  
  // æ‡²ç½°åŸ·è¡Œ (ç›¸å°ç·Šæ€¥)
  demotion_execution: {
    delay: '2_hours', // è¼ƒçŸ­å»¶é²
    preferred_time: {
      weekday: 'any',
      hour: 'business_hours', // ç‡Ÿæ¥­æ™‚é–“
      timezone: 'Asia/Taipei'
    }
  },
  
  // ç·Šæ€¥åŸ·è¡Œ (ç®¡ç†å“¡æ‰‹å‹•)
  emergency_execution: {
    delay: 'immediate',
    override_safety_delays: true,
    require_additional_approval: true
  }
}
```

## ğŸ“Š åŸ·è¡Œç›£æ§å’Œå ±å‘Š

### ğŸ“ˆ ç›£æ§æŒ‡æ¨™
```javascript
const EXECUTION_METRICS = {
  // åŸ·è¡ŒæˆåŠŸç‡
  success_rate: {
    target: '>95%',
    calculation: 'completed_executions / total_executions',
    alert_threshold: '<90%'
  },
  
  // åŸ·è¡Œæ™‚é•·
  execution_duration: {
    target: '<5_minutes',
    steps_breakdown: true,
    performance_tracking: true
  },
  
  // å›æ»¾ç‡
  rollback_rate: {
    target: '<5%',
    root_cause_analysis: true,
    alert_threshold: '>10%'
  }
}
```

### ğŸ“‹ åŸ·è¡Œå ±å‘Šæ¨¡æ¿
```javascript
const EXECUTION_REPORTS = {
  // æ¯æ—¥åŸ·è¡Œæ‘˜è¦
  daily_summary: {
    template: `
    ğŸ“Š è·ä½è®Šæ›´åŸ·è¡Œæ—¥å ± ({date})
    
    âœ… æˆåŠŸåŸ·è¡Œ: {successful_count}
    âŒ åŸ·è¡Œå¤±æ•—: {failed_count}
    ğŸ”„ åŸ·è¡Œå›æ»¾: {rollback_count}
    â±ï¸ å¹³å‡è€—æ™‚: {avg_duration}
    
    ğŸ“‹ è©³ç´°åˆ—è¡¨:
    {execution_details}
    
    ğŸ” éœ€è¦é—œæ³¨çš„å•é¡Œ:
    {issues_requiring_attention}
    `,
    recipients: ['hr_managers', 'system_admins']
  },
  
  // åŸ·è¡Œå¤±æ•—è©³ç´°å ±å‘Š
  failure_detail: {
    template: `
    âŒ è·ä½è®Šæ›´åŸ·è¡Œå¤±æ•—å ±å‘Š
    
    ğŸ‘¤ å“¡å·¥: {employee_name}
    ğŸ“‹ æŠ•ç¥¨æ´»å‹•: {campaign_name}
    ğŸ”§ åŸ·è¡ŒID: {execution_id}
    â° å¤±æ•—æ™‚é–“: {failure_time}
    
    ğŸ“ å¤±æ•—åŸå› : {failure_reason}
    ğŸ”„ åŸ·è¡Œæ­¥é©Ÿ: {failed_step}
    
    ğŸ’¡ å»ºè­°æªæ–½: {recommended_actions}
    `,
    recipients: ['technical_team', 'hr_managers'],
    priority: 'high'
  }
}
```

## ğŸ”§ ç³»çµ±æ•´åˆè¦é»

### ğŸ“¡ èˆ‡ç¾æœ‰ç³»çµ±çš„æ•´åˆ
```javascript
const SYSTEM_INTEGRATIONS = {
  // è–ªè³‡ç³»çµ±æ•´åˆ
  payroll_integration: {
    api_endpoint: '/api/payroll/update-salary',
    data_mapping: {
      employee_id: 'employeeId',
      new_salary_grade: 'salaryGrade',
      effective_date: 'effectiveDate'
    },
    rollback_support: true
  },
  
  // æ¬Šé™ç®¡ç†ç³»çµ±
  permission_system: {
    api_endpoint: '/api/permissions/update-role',
    role_mapping: {
      'å¯¦ç¿’ç”Ÿ': 'trainee_role',
      'å“¡å·¥': 'employee_role', 
      'å‰¯åº—é•·': 'assistant_manager_role',
      'åº—é•·': 'manager_role'
    }
  },
  
  // é€šçŸ¥ç³»çµ±
  notification_system: {
    telegram_integration: true,
    email_integration: false, // æš«æœªå¯¦ç¾
    in_app_notification: true
  }
}
```

## âœ… å¯¦æ–½æª¢æŸ¥æ¸…å–®

### ğŸ¯ å¯¦æ–½å‰æº–å‚™
- [ ] æ•¸æ“šæ¨¡å‹å‰µå»ºå’Œæ¸¬è©¦
- [ ] åŸ·è¡Œé‚è¼¯å–®å…ƒæ¸¬è©¦
- [ ] å›æ»¾æ©Ÿåˆ¶æ¸¬è©¦  
- [ ] å®‰å…¨æª¢æŸ¥æ©Ÿåˆ¶é©—è­‰
- [ ] é€šçŸ¥æ¨¡æ¿æº–å‚™
- [ ] åŸ·è¡Œæ¬Šé™é…ç½®
- [ ] ç›£æ§æŒ‡æ¨™è¨­å®š
- [ ] ç·Šæ€¥è™•ç†æµç¨‹åˆ¶å®š

### ğŸ” å“è³ªä¿è­‰
- [ ] å®Œæ•´çš„åŸ·è¡Œæµç¨‹æ¸¬è©¦
- [ ] ç•°å¸¸æƒ…æ³è™•ç†æ¸¬è©¦
- [ ] ä½µç™¼åŸ·è¡Œå£“åŠ›æ¸¬è©¦
- [ ] æ•¸æ“šä¸€è‡´æ€§é©—è­‰
- [ ] æ€§èƒ½åŸºæº–æ¸¬è©¦
- [ ] å®‰å…¨æ€§æ»²é€æ¸¬è©¦

### ğŸ“‹ ä¸Šç·šæº–å‚™
- [ ] ç”Ÿç”¢ç’°å¢ƒé…ç½®
- [ ] ç›£æ§ç³»çµ±éƒ¨ç½²
- [ ] å ±è­¦æ©Ÿåˆ¶è¨­ç½®
- [ ] æ“ä½œæ‰‹å†Šç·¨å¯«
- [ ] åŸ¹è¨“è¨ˆåŠƒåŸ·è¡Œ
- [ ] æ‡‰æ€¥éŸ¿æ‡‰é æ¡ˆ