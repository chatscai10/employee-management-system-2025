# ⚙️ 結果自動執行系統詳細規劃

## 📋 功能概述
實現投票結果的自動執行機制，包括職位變更、薪資調整、權限更新等完整的人事流程自動化。

## 🔧 數據模型設計

### PositionChangeExecution (職位變更執行表)
```javascript
{
  id: INTEGER (主鍵),
  campaignId: INTEGER (投票活動ID),
  employeeId: INTEGER (員工ID),
  changeType: ENUM('promotion', 'demotion', 'lateral_transfer'),
  oldPosition: STRING (原職位),
  newPosition: STRING (新職位),
  oldSalaryGrade: INTEGER (原薪資等級),
  newSalaryGrade: INTEGER (新薪資等級),
  executionStatus: ENUM('pending', 'in_progress', 'completed', 'failed', 'rolled_back'),
  scheduledExecutionTime: DATE (預定執行時間),
  actualExecutionTime: DATE (實際執行時間),
  executionSteps: JSON (執行步驟記錄),
  executionResults: JSON (執行結果詳情),
  rollbackData: JSON (回滾備份數據),
  approvedBy: INTEGER (審批人ID),
  executedBy: STRING (執行者 - 通常是SYSTEM),
  failureReason: TEXT (失敗原因),
  notificationsSent: JSON (已發送通知記錄),
  createdAt: DATE,
  updatedAt: DATE
}
```

### ExecutionAuditLog (執行審計日誌表)
```javascript
{
  id: INTEGER (主鍵),
  executionId: INTEGER (執行記錄ID),
  step: STRING (執行步驟),
  status: ENUM('started', 'completed', 'failed', 'skipped'),
  startTime: DATE (開始時間),
  endTime: DATE (結束時間),
  duration: INTEGER (執行時長毫秒),
  details: JSON (執行詳情),
  errorMessage: TEXT (錯誤信息),
  systemState: JSON (系統狀態快照),
  createdAt: DATE
}
```

## ⚙️ 執行邏輯流程

### 🎯 自動執行觸發條件
```javascript
const EXECUTION_TRIGGERS = {
  // 投票結束後自動觸發
  automatic: {
    // 轉正投票通過 (50%以上同意)
    promotion_passed: {
      condition: 'agreePercentage >= 50.0',
      delay: '24_hours', // 24小時後執行
      executionSteps: [
        'validate_result',
        'backup_current_state',
        'update_position',
        'adjust_salary',
        'update_permissions',
        'send_notifications',
        'update_system_records'
      ]
    },
    
    // 懲罰投票通過 (30%以上同意)
    demotion_passed: {
      condition: 'agreePercentage >= 30.0',
      delay: 'immediate', // 立即執行
      executionSteps: [
        'validate_result',
        'backup_current_state',
        'downgrade_position',
        'adjust_salary',
        'restrict_permissions',
        'record_disciplinary_action',
        'send_notifications',
        'update_system_records'
      ]
    }
  },
  
  // 手動觸發
  manual: {
    admin_override: {
      requiredRole: 'admin',
      approvalRequired: true,
      auditLogging: true
    }
  }
}
```

### 🔄 執行步驟詳細邏輯
```javascript
const EXECUTION_STEPS = {
  // 步驟1: 結果驗證
  validate_result: {
    checks: [
      '確認投票已正式結束',
      '驗證投票結果完整性',
      '檢查是否有申訴進行中',
      '確認執行條件符合'
    ],
    failureAction: 'abort_execution',
    rollbackRequired: false
  },
  
  // 步驟2: 備份當前狀態
  backup_current_state: {
    backupData: [
      'employee.position',
      'employee.salaryGrade',
      'employee.permissions',
      'employee.positionStartDate',
      'related_system_settings'
    ],
    storageLocation: 'rollbackData',
    rollbackRequired: false
  },
  
  // 步驟3: 更新職位
  update_position: {
    transaction: true,
    operations: [
      {
        table: 'employees',
        action: 'update',
        fields: {
          position: 'newPosition',
          positionStartDate: 'executionTime',
          lastPromotionDate: 'executionTime'
        }
      }
    ],
    rollbackRequired: true
  },
  
  // 步驟4: 調整薪資
  adjust_salary: {
    calculation: {
      promotion: {
        formula: 'baseSalary * promotionMultiplier[newPosition]',
        minimumIncrease: 0.1, // 至少調升10%
        maximumIncrease: 0.3  // 最多調升30%
      },
      demotion: {
        formula: 'baseSalary * demotionMultiplier[newPosition]',
        minimumDecrease: 0.1, // 至少調降10%
        maximumDecrease: 0.2  // 最多調降20%
      }
    },
    rollbackRequired: true
  },
  
  // 步驟5: 權限更新
  update_permissions: {
    systemPermissions: {
      promotion: 'grant_higher_level_access',
      demotion: 'revoke_unnecessary_access'
    },
    storeAccess: {
      managerPromotion: 'grant_store_management_access',
      managerDemotion: 'revoke_store_management_access'
    },
    rollbackRequired: true
  },
  
  // 步驟6: 發送通知
  send_notifications: {
    recipients: [
      'affected_employee',
      'direct_supervisor',
      'hr_department',
      'store_manager'
    ],
    templates: {
      promotion: 'position_change_promotion',
      demotion: 'position_change_demotion'
    },
    rollbackRequired: false
  },
  
  // 步驟7: 更新系統記錄
  update_system_records: {
    records: [
      'position_history',
      'salary_history', 
      'permission_changes',
      'performance_records'
    ],
    rollbackRequired: true
  }
}
```

## 🛡️ 執行安全機制

### 🔒 執行前安全檢查
```javascript
const SAFETY_CHECKS = {
  // 業務邏輯檢查
  business_validation: {
    checks: [
      {
        name: 'minimum_tenure_check',
        rule: '員工在職至少90天才可執行降職',
        applicable: ['demotion']
      },
      {
        name: 'maximum_position_check', 
        rule: '不能晉升超過當前職位+2級',
        applicable: ['promotion']
      },
      {
        name: 'store_capacity_check',
        rule: '檢查目標職位是否有空缺',
        applicable: ['promotion', 'demotion']
      }
    ]
  },
  
  // 系統狀態檢查
  system_validation: {
    checks: [
      '資料庫連接正常',
      '相關系統服務運行',
      '備份系統可用',
      '通知服務正常'
    ]
  },
  
  // 衝突檢查
  conflict_detection: {
    checks: [
      '同一員工是否有其他進行中的變更',
      '相同職位是否有同時執行的變更',
      '系統維護期間禁止執行'
    ]
  }
}
```

### 🔄 回滾機制
```javascript
const ROLLBACK_MECHANISM = {
  // 自動回滾觸發條件
  auto_rollback_triggers: [
    'execution_step_failure',
    'system_error_detected',
    'data_corruption_detected',
    'external_system_failure'
  ],
  
  // 回滾執行步驟
  rollback_steps: [
    {
      step: 'restore_employee_data',
      data_source: 'rollbackData.employee',
      priority: 1
    },
    {
      step: 'restore_salary_data', 
      data_source: 'rollbackData.salary',
      priority: 2
    },
    {
      step: 'restore_permissions',
      data_source: 'rollbackData.permissions', 
      priority: 3
    },
    {
      step: 'cleanup_partial_changes',
      data_source: 'audit_log',
      priority: 4
    },
    {
      step: 'send_rollback_notifications',
      priority: 5
    }
  ],
  
  // 回滾完整性檢查
  rollback_verification: [
    '對比執行前後數據一致性',
    '確認所有系統狀態恢復',
    '驗證權限正確回滾',
    '檢查通知狀態清理'
  ]
}
```

## ⏰ 執行時間控制

### 📅 執行時間策略
```javascript
const EXECUTION_TIMING = {
  // 轉正執行 (非緊急)
  promotion_execution: {
    delay: '24_hours', // 給申訴機會
    preferred_time: {
      weekday: 'monday_to_friday',
      hour: 9, // 上午9點
      timezone: 'Asia/Taipei'
    },
    avoid_periods: [
      'company_holidays',
      'month_end_closing',
      'system_maintenance'
    ]
  },
  
  // 懲罰執行 (相對緊急)
  demotion_execution: {
    delay: '2_hours', // 較短延遲
    preferred_time: {
      weekday: 'any',
      hour: 'business_hours', // 營業時間
      timezone: 'Asia/Taipei'
    }
  },
  
  // 緊急執行 (管理員手動)
  emergency_execution: {
    delay: 'immediate',
    override_safety_delays: true,
    require_additional_approval: true
  }
}
```

## 📊 執行監控和報告

### 📈 監控指標
```javascript
const EXECUTION_METRICS = {
  // 執行成功率
  success_rate: {
    target: '>95%',
    calculation: 'completed_executions / total_executions',
    alert_threshold: '<90%'
  },
  
  // 執行時長
  execution_duration: {
    target: '<5_minutes',
    steps_breakdown: true,
    performance_tracking: true
  },
  
  // 回滾率
  rollback_rate: {
    target: '<5%',
    root_cause_analysis: true,
    alert_threshold: '>10%'
  }
}
```

### 📋 執行報告模板
```javascript
const EXECUTION_REPORTS = {
  // 每日執行摘要
  daily_summary: {
    template: `
    📊 職位變更執行日報 ({date})
    
    ✅ 成功執行: {successful_count}
    ❌ 執行失敗: {failed_count}
    🔄 執行回滾: {rollback_count}
    ⏱️ 平均耗時: {avg_duration}
    
    📋 詳細列表:
    {execution_details}
    
    🔍 需要關注的問題:
    {issues_requiring_attention}
    `,
    recipients: ['hr_managers', 'system_admins']
  },
  
  // 執行失敗詳細報告
  failure_detail: {
    template: `
    ❌ 職位變更執行失敗報告
    
    👤 員工: {employee_name}
    📋 投票活動: {campaign_name}
    🔧 執行ID: {execution_id}
    ⏰ 失敗時間: {failure_time}
    
    📝 失敗原因: {failure_reason}
    🔄 執行步驟: {failed_step}
    
    💡 建議措施: {recommended_actions}
    `,
    recipients: ['technical_team', 'hr_managers'],
    priority: 'high'
  }
}
```

## 🔧 系統整合要點

### 📡 與現有系統的整合
```javascript
const SYSTEM_INTEGRATIONS = {
  // 薪資系統整合
  payroll_integration: {
    api_endpoint: '/api/payroll/update-salary',
    data_mapping: {
      employee_id: 'employeeId',
      new_salary_grade: 'salaryGrade',
      effective_date: 'effectiveDate'
    },
    rollback_support: true
  },
  
  // 權限管理系統
  permission_system: {
    api_endpoint: '/api/permissions/update-role',
    role_mapping: {
      '實習生': 'trainee_role',
      '員工': 'employee_role', 
      '副店長': 'assistant_manager_role',
      '店長': 'manager_role'
    }
  },
  
  // 通知系統
  notification_system: {
    telegram_integration: true,
    email_integration: false, // 暫未實現
    in_app_notification: true
  }
}
```

## ✅ 實施檢查清單

### 🎯 實施前準備
- [ ] 數據模型創建和測試
- [ ] 執行邏輯單元測試
- [ ] 回滾機制測試  
- [ ] 安全檢查機制驗證
- [ ] 通知模板準備
- [ ] 執行權限配置
- [ ] 監控指標設定
- [ ] 緊急處理流程制定

### 🔍 品質保證
- [ ] 完整的執行流程測試
- [ ] 異常情況處理測試
- [ ] 併發執行壓力測試
- [ ] 數據一致性驗證
- [ ] 性能基準測試
- [ ] 安全性滲透測試

### 📋 上線準備
- [ ] 生產環境配置
- [ ] 監控系統部署
- [ ] 報警機制設置
- [ ] 操作手冊編寫
- [ ] 培訓計劃執行
- [ ] 應急響應預案