# 🚀 企業員工管理系統 - 新開發者快速指令手冊

## 📋 文檔概述

本手冊為新開發者提供清晰的步驟指令，按照執行順序整理所有開發任務。

**最後更新**: 2025-08-06  
**預計完成時間**: 12 個工作天  
**系統版本**: v4.0.0

---

## 🎯 Day 0: 前置準備

### 環境需求檢查
```bash
# 檢查 Node.js 版本 (需要 v20+)
node --version

# 檢查 npm 版本
npm --version

# 檢查 Git
git --version

# 安裝 Google Cloud CLI
# Windows
choco install gcloudsdk

# Mac
brew install google-cloud-sdk

# Linux
curl https://sdk.cloud.google.com | bash
```

### 必要帳號準備
- [ ] Google Cloud Platform 帳號
- [ ] Firebase 專案存取權限
- [ ] Telegram Bot Token: `process.env.TELEGRAM_BOT_TOKEN`
- [ ] 測試用 Telegram 群組 ID

---

## 📖 Day 1: 文檔閱讀與理解

### 上午：系統架構理解
```bash
# 按順序閱讀以下文檔
1. COMPLETE-DEVELOPMENT-REPORTS/01-系統架構對比分析報告.md
   - 重點：了解系統從 v1 到 v4 的演進
   - 注意：哪些功能被移除（離線處理、請假系統）

2. COMPLETE-DEVELOPMENT-REPORTS/08-Google-Cloud-Serverless-Architecture-Report.md
   - 重點：Google Cloud 服務選擇與限制
   - 注意：Cloud Run 冷啟動、Firestore 查詢限制
```

### 下午：功能與資料結構
```bash
3. COMPLETE-DEVELOPMENT-REPORTS/02-完整功能規格說明書.md
   - 重點：固定班次 15:00-02:00 的業務邏輯
   - 注意：GPS 100公尺限制

4. COMPLETE-DEVELOPMENT-REPORTS/03-資料庫設計與實現指南.md
   - 重點：7個核心資料表結構
   - 注意：跨日班次的 shiftDate 處理
```

### 晚上：API 與實作細節
```bash
5. COMPLETE-DEVELOPMENT-REPORTS/04-API介面完整文檔.md
   - 重點：28個 API 端點定義
   - 注意：認證機制與錯誤代碼

6. COMPLETE-DEVELOPMENT-REPORTS/10-完整相容性檢查與實作指南.md
   - 重點：解決方案與實作程式碼
   - 注意：相容性問題修正
```

---

## 🛠️ Day 2-3: 基礎環境建置

### Day 2 上午：專案初始化
```bash
# 1. 克隆專案（假設已有 Git repository）
git clone <repository-url>
cd employee-management

# 2. 安裝依賴
npm install

# 3. 建立專案結構
mkdir -p src/{components,services,utils,config,middleware}
mkdir -p src/components/{common,attendance,revenue,inventory,admin}
mkdir -p public/{css,js,images,fonts}
mkdir -p test/{unit,integration,e2e}
```

### Day 2 下午：Google Cloud 設置
```bash
# 1. 登入 Google Cloud
gcloud auth login

# 2. 建立新專案
gcloud projects create employee-mgmt-2025 --name="Employee Management System"
gcloud config set project employee-mgmt-2025

# 3. 啟用必要的 API
gcloud services enable \
  cloudbuild.googleapis.com \
  run.googleapis.com \
  firestore.googleapis.com \
  storage.googleapis.com \
  firebase.googleapis.com \
  cloudlogging.googleapis.com

# 4. 設定預設區域
gcloud config set run/region asia-east1
```

### Day 3 上午：Firebase 設置
```bash
# 1. 安裝 Firebase CLI
npm install -g firebase-tools

# 2. 登入 Firebase
firebase login

# 3. 初始化 Firebase
firebase init

# 選擇以下服務：
# ◉ Firestore
# ◉ Functions (選擇性)
# ◉ Hosting
# ◉ Storage
# ◉ Emulators (用於本地開發)

# 4. 設定 Firestore 索引
# 將以下內容複製到 firestore.indexes.json
```

### firestore.indexes.json
```json
{
  "indexes": [
    {
      "collectionGroup": "attendance",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "employeeId", "order": "ASCENDING" },
        { "fieldPath": "timestamp", "order": "DESCENDING" }
      ]
    },
    {
      "collectionGroup": "revenue",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "storeName", "order": "ASCENDING" },
        { "fieldPath": "date", "order": "DESCENDING" }
      ]
    },
    {
      "collectionGroup": "inventory",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "itemCode", "order": "ASCENDING" },
        { "fieldPath": "currentStock", "order": "ASCENDING" }
      ]
    }
  ]
}
```

### Day 3 下午：環境變數設置
```bash
# 1. 建立環境變數檔案
cp .env.example .env

# 2. 編輯 .env 檔案
```

### .env 內容
```env
# 環境設定
NODE_ENV=development
PORT=8080

# Google Cloud
PROJECT_ID=employee-mgmt-2025
REGION=asia-east1

# Firebase
FIREBASE_API_KEY=your-api-key
FIREBASE_AUTH_DOMAIN=employee-mgmt-2025.firebaseapp.com
FIREBASE_PROJECT_ID=employee-mgmt-2025
FIREBASE_STORAGE_BUCKET=employee-mgmt-2025.appspot.com
FIREBASE_MESSAGING_SENDER_ID=your-sender-id
FIREBASE_APP_ID=your-app-id

# Telegram
TELEGRAM_BOT_TOKEN=process.env.TELEGRAM_BOT_TOKEN
TELEGRAM_BOSS_GROUP_ID=process.env.TELEGRAM_GROUP_ID
TELEGRAM_EMPLOYEE_GROUP_ID=process.env.TELEGRAM_GROUP_ID

# JWT
JWT_SECRET=your-very-secure-secret-key
JWT_EXPIRES_IN=7d

# 門市位置
STORE_LOCATION_LAT=24.9748412
STORE_LOCATION_LNG=121.2556713
STORE_NAME=內壢店
GPS_RADIUS_LIMIT=100
```

---

## 💻 Day 4-5: 核心服務開發

### Day 4：基礎服務實作

#### 1. 錯誤處理機制 (src/middleware/error-handler.js)
```javascript
const { Logging } = require('@google-cloud/logging');

class ErrorHandler {
    constructor() {
        this.logging = new Logging();
        this.log = this.logging.log('employee-app-errors');
        
        this.errorCodes = {
            // 認證錯誤
            E001: { status: 401, message: '認證失敗，請重新登入' },
            E002: { status: 403, message: '權限不足' },
            
            // GPS 錯誤
            E101: { status: 400, message: '無法取得 GPS 定位' },
            E102: { status: 400, message: '距離超過 100 公尺限制' },
            E103: { status: 400, message: 'GPS 精度不足，請移至開闊地帶' },
            
            // 檔案錯誤
            E201: { status: 400, message: '檔案大小超過限制' },
            E202: { status: 400, message: '不支援的檔案格式' },
            E203: { status: 500, message: '檔案上傳失敗' },
            
            // 資料庫錯誤
            E301: { status: 404, message: '找不到資料' },
            E302: { status: 409, message: '資料已存在' },
            E303: { status: 500, message: '資料庫操作失敗' },
            
            // 業務邏輯錯誤
            E401: { status: 400, message: '已經打過卡' },
            E402: { status: 400, message: '不在打卡時間範圍內' },
            E403: { status: 400, message: '營收資料不完整' },
            E404: { status: 400, message: '庫存不足' }
        };
    }
    
    middleware() {
        return async (err, req, res, next) => {
            await this.logError(err, req);
            
            if (err.code && this.errorCodes[err.code]) {
                const errorInfo = this.errorCodes[err.code];
                return res.status(errorInfo.status).json({
                    success: false,
                    code: err.code,
                    message: errorInfo.message,
                    timestamp: new Date().toISOString()
                });
            }
            
            res.status(500).json({
                success: false,
                code: 'E500',
                message: '系統錯誤，請稍後再試',
                timestamp: new Date().toISOString()
            });
        };
    }
    
    static createError(code, additionalInfo) {
        const error = new Error();
        error.code = code;
        if (additionalInfo) {
            error.additionalInfo = additionalInfo;
        }
        return error;
    }
}

module.exports = ErrorHandler;
```

#### 2. 跨日班次處理 (src/utils/shift-handler.js)
```javascript
class ShiftHandler {
    constructor() {
        this.shiftStart = { hour: 15, minute: 0 };
        this.shiftEnd = { hour: 2, minute: 0 };
        this.graceMinutes = 10;
    }
    
    getShiftDate(clockTime) {
        const time = new Date(clockTime);
        const hour = time.getHours();
        
        if (hour >= 0 && hour < 3) {
            const shiftDate = new Date(time);
            shiftDate.setDate(shiftDate.getDate() - 1);
            return shiftDate.toISOString().split('T')[0];
        }
        
        return time.toISOString().split('T')[0];
    }
    
    checkIfLate(clockInTime) {
        const time = new Date(clockInTime);
        const hour = time.getHours();
        const minute = time.getMinutes();
        
        const clockMinutes = hour * 60 + minute;
        const shiftStartMinutes = this.shiftStart.hour * 60 + this.shiftStart.minute;
        const graceEndMinutes = shiftStartMinutes + this.graceMinutes;
        
        if (clockMinutes >= shiftStartMinutes && clockMinutes <= graceEndMinutes) {
            return { isLate: false, lateMinutes: 0 };
        }
        
        if (clockMinutes > graceEndMinutes) {
            const lateMinutes = clockMinutes - graceEndMinutes;
            return { isLate: true, lateMinutes };
        }
        
        return { isLate: false, lateMinutes: 0 };
    }
}

module.exports = new ShiftHandler();
```

### Day 5：認證與資料庫服務

#### 執行指令
```bash
# 安裝必要套件
npm install jsonwebtoken bcryptjs firebase-admin @google-cloud/firestore @google-cloud/storage
```

---

## 🎯 Day 6-10: 功能模組開發

### Day 6-7: 登入系統
```bash
# 開發檔案
- src/services/auth.service.js
- src/middleware/auth.middleware.js
- public/login.html
- public/js/login.js
```

### Day 8-9: GPS 打卡系統
```bash
# 開發檔案
- src/services/attendance.service.js
- src/utils/gps.utils.js
- public/attendance.html
- public/js/attendance.js

# 測試 GPS 功能
npm run test:gps
```

### Day 10: 營收與庫存管理
```bash
# 開發檔案
- src/services/revenue.service.js
- src/services/inventory.service.js
- src/services/storage.service.js
- public/revenue.html
- public/inventory.html
```

---

## 🚀 Day 11-12: 部署與測試

### Day 11：建構與本地測試

#### 1. 建立 Dockerfile
```dockerfile
FROM node:20-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY . .

ENV NODE_ENV=production
ENV PORT=8080

HEALTHCHECK --interval=30s --timeout=3s --start-period=40s --retries=3 \
  CMD node healthcheck.js

EXPOSE 8080

CMD ["node", "app.js"]
```

#### 2. 本地測試
```bash
# 啟動 Firebase 模擬器
firebase emulators:start

# 另一個終端機執行應用
npm run dev

# 執行測試
npm test
```

### Day 12：部署到 Google Cloud

#### 1. 部署後端到 Cloud Run
```bash
# 建構容器映像
gcloud builds submit --tag gcr.io/employee-mgmt-2025/api

# 部署到 Cloud Run
gcloud run deploy employee-api \
  --image gcr.io/employee-mgmt-2025/api \
  --platform managed \
  --region asia-east1 \
  --allow-unauthenticated \
  --set-env-vars NODE_ENV=production \
  --min-instances 1 \
  --max-instances 10 \
  --memory 512Mi
```

#### 2. 部署前端到 Firebase Hosting
```bash
# 建構前端
npm run build

# 部署
firebase deploy --only hosting
```

#### 3. 執行瀏覽器驗證測試
```bash
# 安裝 Puppeteer
npm install puppeteer

# 執行智慧瀏覽器驗證
node test/intelligent-browser-verification-template.js
```

---

## ✅ 最終檢查清單

### 功能檢查
- [ ] 登入功能正常
- [ ] GPS 打卡距離驗證
- [ ] 跨日班次處理正確
- [ ] 營收資料提交與計算
- [ ] 照片上傳到 Cloud Storage
- [ ] 庫存管理與低庫存警告
- [ ] Telegram 通知發送
- [ ] 管理員可修改 Telegram 群組 ID

### 技術檢查
- [ ] 所有 API 端點正常運作
- [ ] 錯誤處理機制完善
- [ ] 資料庫索引建立完成
- [ ] 安全規則設定正確
- [ ] 環境變數配置完整
- [ ] Cloud Run 冷啟動時間 < 5秒
- [ ] 頁面載入時間 < 3秒

### 部署檢查
- [ ] Cloud Run 服務運行中
- [ ] Firebase Hosting 可訪問
- [ ] 自訂網域 SSL 證書有效
- [ ] Cloud Logging 記錄正常
- [ ] 監控告警設置完成

---

## 🆘 常見問題解決

### 1. Firestore 權限錯誤
```bash
# 確認 Firebase 規則已部署
firebase deploy --only firestore:rules
```

### 2. Cloud Run 冷啟動太慢
```bash
# 設定最小實例數
gcloud run services update employee-api --min-instances=1
```

### 3. Telegram 通知失敗
```bash
# 檢查 Bot Token 和群組 ID
curl https://api.telegram.org/botprocess.env.TELEGRAM_BOT_TOKEN/getUpdates
```

### 4. GPS 定位問題
```javascript
// 確保使用 HTTPS
if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
    alert('GPS 功能需要 HTTPS 連線');
}
```

---

## 📞 支援資源

- **開發文檔**: `/COMPLETE-DEVELOPMENT-REPORTS/`
- **API 文檔**: `/COMPLETE-DEVELOPMENT-REPORTS/04-API介面完整文檔.md`
- **疑難排解**: `/COMPLETE-DEVELOPMENT-REPORTS/10-完整相容性檢查與實作指南.md`
- **Google Cloud 文檔**: https://cloud.google.com/docs
- **Firebase 文檔**: https://firebase.google.com/docs

---

## 🎉 完成確認

恭喜！如果您已完成以上所有步驟，系統應該已經成功部署並運行。

最後確認事項：
1. 訪問部署的網站，測試所有功能
2. 檢查 Cloud Logging 確認沒有錯誤
3. 發送測試 Telegram 通知
4. 執行瀏覽器自動化測試確認系統穩定性

**預計完成時間**: 12 個工作天  
**實際完成日期**: _______________

---

**文檔版本**: v1.0  
**建立日期**: 2025-08-06  
**作者**: AI 開發團隊