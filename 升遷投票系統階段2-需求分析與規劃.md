# 升遷投票系統階段2 - 複雜投票機制需求分析與系統規劃

## 📋 需求分析報告

### 1. 核心需求梳理

#### **A. 投票修改機制 (Vote Modification System)**
```
功能需求：
- 員工投票後可修改3次
- 支援同意/不同意的切換
- 記錄每次修改歷史
- 最終以最後一次投票為準

技術需求：
- 擴展 PromotionVote 模型增加修改次數欄位
- 新增 VoteHistory 模型記錄修改歷史
- 修改投票 API 支援更新操作
- 前端界面顯示剩餘修改次數
```

#### **B. 新人轉正自動投票機制 (Automatic Promotion Voting)**
```
功能需求：
- 到職滿20天自動觸發轉正投票
- 投票時長5天 (00:00-00:00)
- 全體在職員工參與
- 50%同意比例通過
- 失敗30天緩衝期
- 系統只自動發起第一次，後續需員工自己申請

技術需求：
- 新增定時任務檢查員工到職天數
- 擴展 PromotionCampaign 增加投票類型欄位
- 自動創建轉正投票活動
- Telegram 群組通知功能
- 緩衝期管理機制
```

#### **C. 降職懲罰自動投票機制 (Automatic Demotion Voting)**
```
功能需求：
- 觸發條件：月遲到分鐘>10 OR 遲到次數>3
- 投票時長3天
- 30%同意比例成立
- 無緩衝期，可連續觸發
- 每月1號重置統計
- 智能階級降級分析

技術需求：
- 新增 AttendanceStatistics 模型統計遲到數據
- 定時任務監控遲到情況
- 階級降級邏輯引擎
- 連續懲罰重疊處理
- 每月統計重置機制
```

#### **D. 多重投票管理系統 (Multi-Voting Management)**
```
功能需求：
- 系統投票不受其他投票影響
- 同時進行多個系統投票
- 員工手動投票檢查衝突
- 管理員手動開啟任何投票

技術需求：
- 投票優先級和類型管理
- 投票衝突檢測算法
- 並發投票狀態管理
- 管理員權限控制系統
```

### 2. 現有系統相容性分析

#### **✅ 相容的現有功能**
1. **員工模型** - 已包含 hireDate, position, status 等必要欄位
2. **打卡系統** - 已有 AttendanceRecord 模型，包含 status 遲到檢測
3. **升遷投票基礎** - PromotionCampaign, PromotionCandidate, PromotionVote 已建立
4. **匿名投票機制** - 加密Token系統已實現
5. **通知系統** - Telegram 通知基礎已存在

#### **🔧 需要擴展的功能**
1. **投票模型擴展** - 增加修改次數、投票類型、優先級
2. **統計系統** - 新建遲到統計模型和定時計算
3. **定時任務系統** - 自動觸發投票的排程機制
4. **階級管理** - 職位晉升/降級的邏輯引擎
5. **並發控制** - 多重投票的狀態管理

#### **⚠️ 潛在風險點**
1. **數據庫鎖定** - 多重投票可能造成併發問題
2. **定時任務重疊** - 需要防止重複觸發
3. **通知暴增** - 多重投票可能產生大量通知
4. **權限複雜度** - 不同投票類型的權限管理

### 3. 數據庫架構規劃

#### **A. 新增模型需求**

##### **1. AttendanceStatistics (遲到統計模型)**
```sql
CREATE TABLE attendance_statistics (
    id INTEGER PRIMARY KEY,
    employeeId INTEGER NOT NULL,
    year INTEGER NOT NULL,
    month INTEGER NOT NULL,
    lateCount INTEGER DEFAULT 0,        -- 遲到次數
    lateMinutesTotal INTEGER DEFAULT 0, -- 遲到總分鐘數
    lastUpdated DATETIME,
    isPunishmentTriggered BOOLEAN DEFAULT FALSE,
    punishmentCount INTEGER DEFAULT 0,  -- 當月懲罰次數
    UNIQUE(employeeId, year, month)
);
```

##### **2. VoteModificationHistory (投票修改歷史)**
```sql
CREATE TABLE vote_modification_history (
    id INTEGER PRIMARY KEY,
    originalVoteId INTEGER NOT NULL,
    employeeId INTEGER NOT NULL,
    campaignId INTEGER NOT NULL,
    modificationNumber INTEGER NOT NULL, -- 第幾次修改
    oldDecision VARCHAR(20),             -- 原決定
    newDecision VARCHAR(20),             -- 新決定
    modifiedAt DATETIME NOT NULL,
    ipAddress VARCHAR(45),
    userAgent TEXT
);
```

##### **3. PromotionCampaign 擴展欄位**
```sql
ALTER TABLE promotion_campaigns ADD COLUMN:
    campaignSubType VARCHAR(50),  -- 'manual', 'auto_promotion', 'auto_demotion'
    triggerConditions JSON,       -- 觸發條件 (遲到統計等)
    priority INTEGER DEFAULT 0,  -- 優先級 (系統投票優先級高)
    canModifyVotes BOOLEAN DEFAULT TRUE,  -- 是否允許修改投票
    maxModifications INTEGER DEFAULT 3,   -- 最大修改次數
    bufferPeriodDays INTEGER DEFAULT 0,   -- 緩衝天數
    passThreshold DECIMAL(5,2) DEFAULT 50.00  -- 通過門檻百分比
```

##### **4. PromotionVote 擴展欄位**
```sql
ALTER TABLE promotion_votes ADD COLUMN:
    modificationCount INTEGER DEFAULT 0,     -- 已修改次數
    canStillModify BOOLEAN DEFAULT TRUE,     -- 是否還能修改
    originalDecision VARCHAR(20),           -- 原始決定
    currentDecision VARCHAR(20),            -- 當前決定
    lastModifiedAt DATETIME                 -- 最後修改時間
```

### 4. API接口規劃

#### **A. 投票修改相關API**
```
PUT /api/promotion/campaigns/:id/vote/:voteId/modify
- 修改已存在的投票
- 檢查修改次數限制
- 記錄修改歷史

GET /api/promotion/campaigns/:id/vote/:voteId/history  
- 獲取投票修改歷史

GET /api/promotion/campaigns/:id/vote/:voteId/status
- 檢查投票修改狀態和剩餘次數
```

#### **B. 自動投票系統API**
```
POST /api/promotion/auto-campaigns/check-conditions
- 檢查自動投票觸發條件 (管理員用)

GET /api/promotion/auto-campaigns/pending
- 獲取待觸發的自動投票

POST /api/promotion/auto-campaigns/manual-trigger
- 管理員手動觸發自動投票
```

#### **C. 統計和監控API**  
```
GET /api/attendance/statistics/:employeeId/:year/:month
- 獲取員工月度遲到統計

POST /api/attendance/statistics/recalculate
- 重新計算遲到統計 (管理員用)

GET /api/promotion/campaigns/conflicts
- 檢查投票衝突狀況
```

### 5. 定時任務規劃

#### **A. 每日任務 (每天00:00執行)**
```javascript
// 1. 檢查新人到職20天轉正投票
checkNewEmployeePromotion()

// 2. 檢查投票活動到期
checkExpiredCampaigns()  

// 3. 檢查遲到統計觸發懲罰投票
checkLatenessForDemotion()
```

#### **B. 每月任務 (每月1號00:00執行)**
```javascript
// 1. 重置所有員工遲到統計
resetMonthlyAttendanceStats()

// 2. 清理過期的投票修改歷史
cleanupExpiredVoteHistory()
```

### 6. 業務邏輯引擎規劃

#### **A. 新人轉正邏輯引擎**
```javascript
class NewEmployeePromotionEngine {
    // 檢查是否符合轉正投票條件
    checkPromotionEligibility(employee) {
        const daysWorked = this.calculateWorkingDays(employee.hireDate);
        const hasExistingCampaign = this.checkExistingPromotionCampaign(employee.id);
        const isInBufferPeriod = this.checkBufferPeriod(employee.id);
        
        return daysWorked >= 20 && !hasExistingCampaign && !isInBufferPeriod;
    }
    
    // 自動創建轉正投票
    createAutomaticPromotionCampaign(employee) {
        // 創建5天投票期的轉正投票
        // 通知管理員和員工群組
        // 設定50%通過門檻
    }
}
```

#### **B. 降職懲罰邏輯引擎**
```javascript  
class DemotionPunishmentEngine {
    // 檢查遲到統計是否觸發懲罰
    checkDemotionConditions(employeeId, year, month) {
        const stats = this.getAttendanceStats(employeeId, year, month);
        
        // 條件1: 遲到分鐘數 > 10
        const minuteCondition = stats.lateMinutesTotal > 10;
        
        // 條件2: 遲到次數 > 3
        const countCondition = stats.lateCount > 3;
        
        return minuteCondition || countCondition;
    }
    
    // 智能階級降級分析
    analyzePositionDemotion(employee, existingCampaigns) {
        // 檢查是否有進行中的懲罰投票
        // 預測第一次懲罰結果
        // 決定第二次懲罰的目標職位
    }
}
```

### 7. 通知系統擴展

#### **A. 新增通知模板**
```javascript
const notificationTemplates = {
    // 新人轉正投票通知
    NEW_EMPLOYEE_PROMOTION: {
        admin: "🏢 系統通知：員工 {name} 已到職滿20天，轉正投票已自動開啟，請大家評估其工作表現。",
        employee: "📊 投票通知：員工 {name} 轉正投票已開始，請各位同事參與投票。"
    },
    
    // 降職懲罰投票通知  
    DEMOTION_PUNISHMENT: {
        admin: "⚠️ 懲罰通知：員工 {name} 因遲到問題觸發降職投票 (遲到{count}次/{minutes}分鐘)。",
        employee: "📋 投票通知：降職懲罰投票已開始，請評估相關員工情況。"
    },
    
    // 投票修改提醒
    VOTE_MODIFICATION: {
        employee: "✏️ 投票修改：您已修改投票 {count}/{maxCount} 次，請謹慎考慮。"
    }
}
```

### 8. 前端界面規劃

#### **A. 投票界面擴展**
- 顯示剩餘修改次數
- 投票修改歷史查看
- 不同投票類型的視覺區分
- 多重投票狀態指示

#### **B. 管理員控制面板**
- 自動投票觸發條件監控
- 遲到統計實時查看
- 手動觸發投票功能
- 投票衝突解決工具

### 9. 測試規劃

#### **A. 單元測試**
- 投票修改邏輯測試
- 自動觸發條件測試  
- 階級降級算法測試
- 並發投票處理測試

#### **B. 整合測試**
- 端到端投票流程測試
- 定時任務執行測試
- 通知系統發送測試
- 多用戶並發測試

#### **C. 壓力測試**
- 大量並發投票測試
- 多重投票性能測試
- 數據庫鎖定測試

### 10. 風險評估與緩解策略

#### **⚠️ 高風險項目**
1. **併發控制複雜度** - 多重投票可能造成數據競爭
   - 緩解：使用數據庫事務和鎖機制
   
2. **定時任務重複執行** - 可能造成重複投票創建  
   - 緩解：增加執行狀態檢查和冪等性設計
   
3. **通知暴增問題** - 多重投票產生過多通知
   - 緩解：通知聚合和頻率限制

4. **權限管理複雜** - 不同投票類型權限混淆
   - 緩解：基於角色的權限控制(RBAC)

#### **🔧 技術債務**
- 需要重構現有投票模型以支援新功能
- 定時任務系統需要可靠的錯誤處理
- 前端界面需要適應複雜的投票狀態

### 11. 實施計劃

#### **階段2.1 - 基礎擴展 (預計3天)**
- [ ] 擴展數據庫模型
- [ ] 實現投票修改API
- [ ] 基礎定時任務框架

#### **階段2.2 - 自動投票系統 (預計4天)**  
- [ ] 新人轉正自動投票
- [ ] 降職懲罰自動投票
- [ ] 遲到統計系統

#### **階段2.3 - 並發控制與優化 (預計2天)**
- [ ] 多重投票管理
- [ ] 並發控制優化
- [ ] 性能測試與調優

#### **階段2.4 - 前端界面與測試 (預計3天)**
- [ ] 前端界面更新
- [ ] 完整測試驗證
- [ ] 文檔更新

### 12. 成功標準

#### **功能完整性標準**
- ✅ 員工可以修改投票3次並記錄歷史
- ✅ 新人20天自動轉正投票功能正常
- ✅ 遲到懲罰自動投票準確觸發  
- ✅ 多重投票並發處理無衝突
- ✅ 通知系統準確發送各類通知

#### **效能標準**
- ✅ API 響應時間 < 500ms
- ✅ 並發100用戶投票無異常
- ✅ 定時任務執行成功率 > 99%
- ✅ 數據一致性 100%保證

#### **穩定性標準**  
- ✅ 系統7x24小時穩定運行
- ✅ 自動投票0漏報0誤報
- ✅ 數據備份和恢復機制完善

---

## 📝 結論

此需求分析涵蓋了升遷投票系統階段2的所有複雜功能，包含詳細的技術規劃和風險評估。系統具備良好的可擴展性和相容性，可以在現有架構基礎上穩健地實現這些進階功能。

**建議執行順序：**
1. 首先實現資料庫模型擴展和基礎API  
2. 然後開發自動投票觸發機制
3. 最後完成並發控制和前端優化

**預計總開發時間：12天**
**技術複雜度：高等**  
**系統相容性：良好**